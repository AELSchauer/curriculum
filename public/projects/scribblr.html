
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Scribblr: A JavaScript Blogging App - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="Scribblr: A JavaScript Blogging App                              In this project we will create a simple blog using &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tutorials.jumpstartlab.com/projects/scribblr.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">

  <!-- TAB SLIDE OUT -->
  <script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tabSlideOut.v1.3.js"></script>

  <!-- SEARCH -->
  <script src="/search.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.slide-out-div').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        pathToTabImage: '/images/feedback_tabv2.png', //path to the image for the tab //Optionally can be set using css
        imageHeight: '130px',                     //height of tab image           //Optionally can be set using css
        imageWidth: '36px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 300,                               //speed of animation
        action: 'click',                          //options: 'click' or 'hover', action to trigger animation
        topPos: '200px',                          //position from the top/ use if tabLocation is left or right
        leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
        fixedPosition: true                      //options: true makes it stick(fixed position) on scroll
        });
      });
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner">
    <hgroup>
  <h1>Jumpstart Lab Curriculum</h1>
  
</hgroup>

  </header>

  <nav role="navigation">
    <ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tutorials.jumpstartlab.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
  <li><div id="search">
  <form>
    <input type="text" id="st-search-input" class="st-search-input" />
  </form>
</div>
</li>
</ul>
  </nav>

  <div id="main">
    <div id="content">
      <div>
  <article role="article">
    
    
      <header>
        <h1 class="entry-title">
          Scribblr: A JavaScript Blogging App
        </h1>
        
      </header>
    
    <p>In this project we will create a simple blog using JavaScript for portions of the front-end. We&#8217;ll cover:</p>

<ul>
<li>Rails Asset Pipeline</li>
<li>JavaScript Unit Testing with Konacha</li>
<li>JavaScript Integration Testing with Capybara</li>
</ul>

<p>This project assumes you have a small amount of experience with Rails, and will primarily focus on the JavaScript.</p>

<h2>0. Initial Setup</h2>

<h3>Chrome</h3>

<p>We will be using the Chrome developer tools. <a href="https://www.google.com/intl/en/chrome/browser/">Download and install Chrome</a> if you don&#8217;t already have it installed. The developer tools are included by default, so you don&#8217;t need to install any add-ons or plugins.</p>

<h3>Rails</h3>

<p>First off, we need a Rails project. We&#8217;re going to work with Rails 4, which as of the writing of this material is currently on RC1, which is a prerelease. You will need at least Ruby 1.9.3, and Ruby 2.0.0 is recommended.</p>

<p>Install Rails 4&#8217;s RC1 with this command:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>gem install rails -v 4.0.0.rc1</span></code></pre></td></tr></table></div></div>
        </div>

<p>Next, setup our initial project. It&#8217;s going to be a JavaScript heavy Blog, so let&#8217;s give it a cool name, like Scribblr:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails new scribblr</span><span class='line command'>cd scribblr</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now let&#8217;s boot up the Rails server:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails server</span><span class='line output'>=> Booting WEBrick</span><span class='line output'>=> Rails 4.0.0.rc1 application starting in development on http://0.0.0.0:3000</span><span class='line output'>=> Run `rails server -h` for more startup options</span><span class='line output'>=> Ctrl-C to shutdown server</span><span class='line output'>[2013-06-01 14:00:12] INFO  WEBrick 1.3.1</span><span class='line output'>[2013-06-01 14:00:12] INFO  ruby 2.0.0 (2013-05-14) [x86_64-darwin12.3.0]</span><span class='line output'>[2013-06-01 14:00:12] INFO  WEBrick::HTTPServer#start: pid=51959 port=3000</span></code></pre></td></tr></table></div></div>
        </div>

<p>Note that on the last line our server is running on port 3000. Visit <a href="http://localhost:3000">localhost:3000</a> and you should see Rails&#8217;s welcome screen.</p>

<h2>1. Posts</h2>

<p>To start with, we will need the basic interface for our blogging application, plus the associated database tables and ActiveRecord models.</p>

<h3>Scaffold</h3>

<p>We&#8217;re going to use Rails&#8217;s built-in generators so we can get started quickly.Create a Post scaffold with a title and body:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails g scaffold post title:string body:text</span><span class='line output'>invoke  active_record</span><span class='line output'>create    db/migrate/20130601180801_create_posts.rb</span><span class='line output'>create    app/models/post.rb</span><span class='line output'>invoke    test_unit</span><span class='line output'>create      test/models/post_test.rb</span><span class='line output'>create      test/fixtures/posts.yml</span><span class='line output'>invoke  resource_route</span><span class='line output'>route    resources :posts</span><span class='line output'>invoke  jbuilder_scaffold_controller</span><span class='line output'>create    app/controllers/posts_controller.rb</span><span class='line output'>invoke    erb</span><span class='line output'>create      app/views/posts</span><span class='line output'>create      app/views/posts/index.html.erb</span><span class='line output'>create      app/views/posts/edit.html.erb</span><span class='line output'>create      app/views/posts/show.html.erb</span><span class='line output'>create      app/views/posts/new.html.erb</span><span class='line output'>create      app/views/posts/_form.html.erb</span><span class='line output'>invoke    test_unit</span><span class='line output'>create      test/controllers/posts_controller_test.rb</span><span class='line output'>invoke    helper</span><span class='line output'>create      app/helpers/posts_helper.rb</span><span class='line output'>invoke      test_unit</span><span class='line output'>create        test/helpers/posts_helper_test.rb</span><span class='line output'>invoke    jbuilder</span><span class='line output'>exist      app/views/posts</span><span class='line output'>create      app/views/posts/index.json.jbuilder</span><span class='line output'>create      app/views/posts/show.json.jbuilder</span><span class='line output'>invoke  assets</span><span class='line output'>invoke    coffee</span><span class='line output'>create      app/assets/javascripts/posts.js.coffee</span><span class='line output'>invoke    scss</span><span class='line output'>create      app/assets/stylesheets/posts.css.scss</span><span class='line output'>invoke  scss</span><span class='line output'>create    app/assets/stylesheets/scaffolds.css.scss</span></code></pre></td></tr></table></div></div>
        </div>

<p>Wow, a lot just happened there! Let&#8217;s walk through it:</p>

<ol>
<li><code>active_record</code>: this is our database migration, model, and unit tests</li>
<li><code>resource_route</code>: this sets up <code>/posts</code> routes</li>
<li><code>jbuilder_scaffold_controller</code>: this builds the controller, html views, controller test, helper, and jbuilder views (for JSON output)</li>
<li><code>assets</code>: coffeescript and scss files for posts</li>
<li><code>scss</code>: because this is our first scaffold, it brings in the default scaffold style</li>
</ol>

<h3>Migrate</h3>

<p>We need to run the pending database migrations so that we have the appropriate tables and columns in our application.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line output'>rake db:migrate</span><span class='line output'>==  CreatePosts: migrating ====================================================</span><span class='line output'>-- create_table(:posts)</span><span class='line output'>-> 0.0013s</span><span class='line output'>==  CreatePosts: migrated (0.0014s) ===========================================</span></code></pre></td></tr></table></div></div>
        </div>

<p>Run the server (<code>rails server</code>) and visit <a href="localhost:3000/posts">localhost:3000/posts</a>. You should see an empty list of posts.</p>

<h2>2. Asset Pipeline</h2>

<p>Now that we have an application to explore, let&#8217;s talk about the Rails asset pipeline. When we built our scaffold it included a separate scaffolds file in <code>app/assets/stylesheets/scaffolds.css.scss</code>. Let&#8217;s look at how that scaffold file gets included into our page.</p>

<p>In Chrome, open up the Inspector. On a Mac this is Option+Command+I, on Windows it is F12. You can also find it under the View menu, then the Developer submenu, or by right clicking on the page and clicking &quot;Inspect&quot;.</p>

<p>Next, click on the Network tab at the top of the inspector, then refresh the page. You should see all the assets transferred to load this web page. At the bottom of the inspector, click Stylesheets. This should filter the list down to just the css files included in the page. You should see three files:</p>

<p><img src="/images/scribblr/inspector-stylesheets.png" alt="Inspector with Stylesheets">
</p>

<p>We have the <code>posts.css</code> file, <code>scaffolds.css</code>, and <code>application.css</code>.</p>

<p>Click on <code>application.css</code> each one to see what&#8217;s inside each file. Note that only <code>scaffolds.css</code> has any real content.</p>

<p>Open up <code>app/assets/stylesheets/application.css</code> in your editor. Aside from the comments we saw in the inspector, there are two special directives at the end that look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'> <span class="o">*=</span> <span class="nt">require_self</span>
</span><span class='line'> <span class="o">*=</span> <span class="nt">require_tree</span> <span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>

<p>These are Asset Pipeline require directives. They tell the Rails application what files to load in order to build <code>application.css</code>. The first one says to include the code found in <code>application.css</code> itself. The second tells Rails to scan the current directory tree for files, and include them.</p>

<p>Let&#8217;s look at the directory tree for stylesheets:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>tree app/assets/stylesheets/</span><span class='line output'>app/assets/stylesheets/</span><span class='line output'>├── application.css</span><span class='line output'>├── posts.css.scss</span><span class='line output'>└── scaffolds.css.scss</span><span class='line output'></span><span class='line output'>0 directories, 3 files</span></code></pre></td></tr></table></div></div>
        </div>

<p>So that makes sense, the Asset Pipeline found the posts and scaffolds files and sent them to the browser. Now, how did it do that?</p>

<p>Click over to the &quot;Elements&quot; tab in the inspector, and drive down into the <code>head</code> tag.</p>

<p><img src="/images/scribblr/inspector-head.png" alt="Inspector with Head Tags">
</p>

<p>You can see we have three <code>link</code> tags that are including those three css files. Open up <code>app/views/layouts/application.html.erb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="err">&lt;</span>%= stylesheet_link_tag    &quot;application&quot;, media: &quot;all&quot;, &quot;data-turbolinks-track&quot; =&gt; true %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>This line asks rails for the stylesheet link tag for <code>&quot;application&quot;</code>, which will read <code>application.css</code>. At this point, we&#8217;re seeing a difference between Rails in development mode versus Rails in production mode.</p>

<p>In development mode, this line includes a separate <code>link</code> tag for every styleshet. That way, it serves them up in an uncompiled, readable way that makes it way easier to develop and application. Now let&#8217;s look at how Rails behaves in production mode.</p>

<h3>Production mode</h3>

<p>Stop your server and run migrations in production mode.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>RAILS_ENV=production rake db:migrate</span><span class='line output'>==  CreatePosts: migrating ====================================================</span><span class='line output'>-- create_table(:posts)</span><span class='line output'>-> 0.0015s</span><span class='line output'>==  CreatePosts: migrated (0.0016s) ===========================================</span></code></pre></td></tr></table></div></div>
        </div>

<p>Run the server in production mode:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails server -e production</span><span class='line output'>=> Booting WEBrick</span><span class='line output'>=> Rails 4.0.0.rc1 application starting in production on http://0.0.0.0:3000</span><span class='line output'>=> Run `rails server -h` for more startup options</span><span class='line output'>=> Ctrl-C to shutdown server</span><span class='line output'>[2013-06-01 14:44:58] INFO  WEBrick 1.3.1</span><span class='line output'>[2013-06-01 14:44:58] INFO  ruby 2.0.0 (2013-05-14) [x86_64-darwin12.3.0]</span><span class='line output'>[2013-06-01 14:44:58] INFO  WEBrick::HTTPServer#start: pid=52481 port=3000</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now visit <a href="http://localhost:3000/posts">localhost:3000/posts</a>.</p>

<p>Notice that the scaffold styles have not been applied. If you look in the inspector&#8217;s Network tab, you&#8217;ll see that <code>application.css</code> is red. If you click on it and click the Headers tab the status shows 404 Not Found.</p>

<p>This is because in production mode, Rails will not serve your assets. It would be poor performance practice to serve lots of small css files, especially without minifying them first.</p>

<p>There&#8217;s a Rails task you must run in order to prepare your assets for production mode:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<br></pre></td><td class='code'><pre><code><span class='line command'>rake assets:precompile</span><span class='line output'>I, [2013-06-01T14:50:25.145311 #52543]  INFO -- : Writing scribblr/public/assets/application-2afd65459052c45a9e23d317dc22ee64.js</span><span class='line output'>I, [2013-06-01T14:50:25.189536 #52543]  INFO -- : Writing scribblr/public/assets/application-12b3c7dd74d2e9df37e7cbb1efa76a6d.css</span></code></pre></td></tr></table></div></div>
        </div>

<p>That built our <code>application.css</code> file, creating a file named <code>application-12b3c7dd74d2e9df37e7cbb1efa76a6d.css</code>. The hash included on the end will be different if the stylesheets change and we recompile the assets. This helps bust browser caches.</p>

<p>If you refresh the page, it&#8217;s still not serving the file.</p>

<p>In production mode, Rails doesn&#8217;t serve static files at all. It&#8217;s best to have a real web server, like Apache or nginx serving static files. However, in our case, let&#8217;s make Rails do that too.</p>

<p>Edit <code>config/environments/production.rb</code> and change this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Disable Rails&#39;s static asset server (Apache or nginx will already do this).</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">serve_static_assets</span> <span class="o">=</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>

<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Enable Rails&#39;s static asset server (Apache or nginx will already do this).</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">serve_static_assets</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>

<p>You will need to restart your Rails server for it to pick up the change.</p>

<p>Open the inspector&#8217;s network tab and click on <code>application.css</code>. You can see that it contains both the comment from <code>application.css</code> as well as the styles from <code>scaffolds.css</code></p>

<h3>Wrap-up</h3>

<p>We only talked about CSS, but the same process applies to JavaScript, and we&#8217;ll explore JavaScript files more in the following sections.</p>

<p>One last command that may come in handy is:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake assets:clobber</span><span class='line output'>I, [2013-06-01T15:18:07.209737 #52752]  INFO -- : Removed scribblr/public/assets</span><span class='line output'>rm -rf scribblr/tmp/cache/assets</span></code></pre></td></tr></table></div></div>
        </div>

<p>That clears out any compiled assets. This is not necessary in production or development, but it&#8217;s nice to know in case you suspect that data is being cached and you&#8217;re troubleshooting.</p>

<h3>Switch back to development mode</h3>

<p>From now on, we&#8217;re going to go back to running rails server in development mode so that we can see changes without restarting the server. Go ahead and run the server as <code>rails server</code> without the production option.</p>

<h2>3. Twitter Bootstrap</h2>

<p>To quickly improve the look of our application, we&#8217;re going to bring in Twitter Bootstrap. The <code>twitter-bootstrap-rails</code> gem wraps up Twitter Bootstrap in a Rails Engine. That means the gem can provide code at all levels of a Rails application. The <code>twitter-bootstrap-rails</code> gem includes:</p>

<ul>
<li>CSS Assets</li>
<li>JavaScript Assets</li>
<li>Icons (in the form of icon fonts)</li>
<li>Images</li>
<li>Generators</li>
<li>Helpers</li>
</ul>

<h3>Install and Setup</h3>

<h4>Remove Turbolinks</h4>

<p>We&#8217;re going to be doing some JavaScript that will conflict with <code>turbolinks</code>. Turbolinks accelerates simple html pages very effectively, but for simplicity&#8217;s sake we&#8217;re going to remove it from our application since it doesn&#8217;t behave well with heavy JavaScript applications.</p>

<p>Edit <code>Gemfile</code> and <strong>comment out or remove</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Turbolinks makes following links in your web application faster. Read more: https://github.com/rails/turbolinks</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;turbolinks&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then edit <code>app/assets/javascripts/application.js</code> and remove the turbolinks line there.</p>

<h4>Install <code>twitter-bootstrap-rails</code></h4>

<p>First off, let&#8217;s add it to our Gemfile. It can go anywhere, but let&#8217;s put it near the other asset-oriented gems. I&#8217;m going to put it under <code>jquery-rails</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;twitter-bootstrap-rails&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Next, we have to bundle the application to bring in the gem:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle</span><span class='line output'>Fetching gem metadata from https://rubygems.org/..........</span><span class='line output'>Fetching gem metadata from https://rubygems.org/..</span><span class='line output'>Resolving dependencies...</span><span class='line output'>... lots of gems ...</span><span class='line output'>Installing twitter-bootstrap-rails (2.2.6)</span></code></pre></td></tr></table></div></div>
        </div>

<p>If you restart your server and refresh your browser, you&#8217;ll note that the application still looks the same. The new assets are available, but they&#8217;re not being loaded by our application.</p>

<p><code>twitter-bootstrap-rails</code> provides a handy generator for installing:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails generate bootstrap:install static</span><span class='line output'>insert  app/assets/javascripts/application.js</span><span class='line output'>create  app/assets/javascripts/bootstrap.js.coffee</span><span class='line output'>create  app/assets/stylesheets/bootstrap_and_overrides.css</span><span class='line output'>create  config/locales/en.bootstrap.yml</span><span class='line output'>gsub  app/assets/stylesheets/application.css</span><span class='line output'>gsub  app/assets/stylesheets/application.css</span></code></pre></td></tr></table></div></div>
        </div>

<p>The main change here is that it added <code>bootstrap_and_overrides.css</code> into <code>app/assets/stylesheets</code>. Open up that file.</p>

<p>There are two require directives here: one for bootstrap, and the second for font-awesome. The bootstrap one is including all of bootstrap&#8217;s styles, and the font-awesome one includes the font-awesome icon font, which is a great starter-kit of icons for a web application.</p>

<p>Now if you restart your server and reload your browser you should see a change. The most noticeable for me is that the main heading font is now a very large sans-serif font.</p>

<h3>Scaffolding</h3>

<p><code>twitter-bootstrap-rails</code> also provides scaffold styles to replace Rails&#8217;s default scaffolding, and it has handy generators for those too.</p>

<p>First we&#8217;ll setup a bootstrap layout:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails g bootstrap:layout application fixed</span><span class='line output'>conflict  app/views/layouts/application.html.erb</span><span class='line output'>Overwrite /Users/nick/workspace/scribblr/app/views/layouts/application.html.erb? (enter "h" for help) [Ynaqdh]</span><span class='line output'>force  app/views/layouts/application.html.erb</span></code></pre></td></tr></table></div></div>
        </div>

<p>Note that I got a prompt due to conflicts in the file. Since this is a new app we can just say <code>Y</code> (or hit enter). In an app with changes to this file, we would want to intelligently merge them ourselves.</p>

<p>Open up <code>app/views/layouts/application.html.erb</code>. <code>twitter-bootstrap-rails</code> does a ton of smart stuff to setup our application layout:</p>

<ol>
<li>A <code>meta</code> tag for the viewport, which will cause phones and tablets to zoom in and use a responsive layout</li>
<li>An html5 shim for older browsers</li>
<li>Alternative high resolution icons for phones</li>
<li>A navigation bar</li>
<li>A sidebar</li>
<li>Bootstrappified flash messages</li>
<li>A footer</li>
<li>JavaScript files at the end of the body, so that the page appears quickly while the JavaScript tags load</li>
</ol>

<p><code>twitter-bootstrap-rails</code> also has a generator to replace the scaffolding styles. Let&#8217;s replace our <code>Post</code> scaffolding styles:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails g bootstrap:themed Posts</span><span class='line output'>conflict  app/views/posts/index.html.erb</span><span class='line output'>Overwrite scribblr/app/views/posts/index.html.erb? (enter "h" for help) [Ynaqdh]</span><span class='line output'>force  app/views/posts/index.html.erb</span><span class='line output'>conflict  app/views/posts/new.html.erb</span><span class='line output'>Overwrite scribblr/app/views/posts/new.html.erb? (enter "h" for help) [Ynaqdh]</span><span class='line output'>force  app/views/posts/new.html.erb</span><span class='line output'>conflict  app/views/posts/edit.html.erb</span><span class='line output'>Overwrite scribblr/app/views/posts/edit.html.erb? (enter "h" for help) [Ynaqdh]</span><span class='line output'>force  app/views/posts/edit.html.erb</span><span class='line output'>conflict  app/views/posts/_form.html.erb</span><span class='line output'>Overwrite scribblr/app/views/posts/_form.html.erb? (enter "h" for help) [Ynaqdh]</span><span class='line output'>force  app/views/posts/_form.html.erb</span><span class='line output'>conflict  app/views/posts/show.html.erb</span><span class='line output'>Overwrite scribblr/app/views/posts/show.html.erb? (enter "h" for help) [Ynaqdh]</span><span class='line output'>force  app/views/posts/show.html.erb</span></code></pre></td></tr></table></div></div>
        </div>

<p>Finally, we want to remove our old scaffold styles that Rails included:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rm app/assets/stylesheets/scaffolds.css.scss</span></code></pre></td></tr></table></div></div>
        </div>

<p>If you reload the page, you&#8217;ll notice there are a couple of things we&#8217;d like to fix:</p>

<ol>
<li>The top content is being cut off</li>
<li>The links in the navbar are examples, and we don&#8217;t need them</li>
<li>The Scribblr link in the navbar doesn&#8217;t go to the root of the app</li>
<li>We don&#8217;t need a sidebar</li>
</ol>

<h4>Top Content Cut Off</h4>

<p>The reason it&#8217;s getting cutoff is because we have a fixed navbar. Fixing an object in css means that it doesn&#8217;t flow with the rest of the content on the page. Open up <code>app/views/layouts/application.html.erb</code> and change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>That should fix our cutoff issue.</p>

<h4>Navbar Links</h4>

<p>Let&#8217;s remove the links in the navbars, and fix the root link. Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/a&gt;</span>
</span><span class='line'>      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Scribblr<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container nav-collapse&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Link1&quot;, &quot;/path1&quot;  %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Link2&quot;, &quot;/path2&quot;  %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Link3&quot;, &quot;/path3&quot;  %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/.nav-collapse --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= link_to &quot;Scribblr&quot;, &quot;/&quot;, class: &quot;brand&quot; %&gt;
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you click on &quot;Scribblr&quot; you&#8217;ll notice that it goes to the rails welcome page. Let&#8217;s fix that by giving our application a root route.</p>

<p>Edit <code>config/routes.rb</code> and right before <code>resources :posts</code> add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span> <span class="n">to</span><span class="p">:</span> <span class="s2">&quot;posts#index&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now edit <code>app/views/layouts/application.html.erb</code> and change the Scribblr link to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= link_to &quot;Scribblr&quot;, root_path, class: &quot;brand&quot; %&gt;
</span></code></pre></td></tr></table></div></figure>

<h4>No Sidebar Needed</h4>

<p>We can remove the sidebar, which means we also don&#8217;t need the spans that setup a 3/4 + 1/4 grid. Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span9&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= bootstrap_flash %&gt;
</span><span class='line'>      <span class="err">&lt;</span>%= yield %&gt;
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well sidebar-nav&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;h3&gt;</span>Sidebar<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-header&quot;</span><span class="nt">&gt;</span>Sidebar<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Link1&quot;, &quot;/path1&quot;  %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Link2&quot;, &quot;/path2&quot;  %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to &quot;Link3&quot;, &quot;/path3&quot;  %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/.well --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/span--&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!--/row--&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;footer&gt;</span>
</span><span class='line'>    <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Company 2013<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/footer&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>%= bootstrap_flash %&gt;
</span><span class='line'>  <span class="err">&lt;</span>%= yield %&gt;
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;footer&gt;</span>
</span><span class='line'>    <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Company 2013<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/footer&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Add Some Posts</h3>

<p>One last change before we proceed: we need some posts! When you go to create a post, you&#8217;ll notice that by default Rails&#8217;s scaffold has used a text field for both inputs. In our case, the <code>body</code> could quite long, so let&#8217;s change that to a <code>textarea</code>.</p>

<p>Edit <code>app/views/posts/_form.html.erb</code> and change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= f.text_field :body, :class =&gt; &#39;text_field&#39; %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= f.text_area :body, :class =&gt; &#39;input-xxlarge&#39;, :rows =&gt; 8 %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>Also let&#8217;s make the title field more spacious too. Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= f.text_field :title, :class =&gt; &#39;text_field&#39; %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= f.text_field :title, :class =&gt; &#39;input-xxlarge&#39; %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>Much better. Now let&#8217;s add some content. Add a couple of posts so we have something to look at.</p>

<p>Now that we have our basic application up and running, it&#8217;s time to get into some JavaScript.</p>

<h2>4. Autosaving Posts</h2>

<p>It&#8217;s time to implement our first JavaScript feature: autosaving posts. In this tutorial, we&#8217;ll write a set of JavaScript functions that will automatically save a post while it is being edited.</p>

<p>We&#8217;re going to build this project using two best practices: <em>Progressive Enhancement</em> and <em>Unobtrusive JavaScript</em>. Progressive enhancement involves layering our JavaScript functionality on top of a traditional form, so that even if JavaScript is not available (or not functioning properly) the form will still work in the usual way of POSTing to the server. Unobtrusive JavaScript means that we will barely change the form itself, and the JavaScript we write will not be directly tied to the form, but instead be setup in a component-oriented way.</p>

<p>Also, we should note that for simplicity&#8217;s sake we&#8217;ll only be enhancing the <code>edit</code> page, not the <code>new</code> page. This is just because it will be easier for us to update an existing post, instead of storing a new post in a new <code>drafts</code> table.</p>

<h3>HTML5 Enhancements</h3>

<h4>The Placeholder Attribute</h4>

<p>Before we even touch JavaScript, there are a number of things we can add to the edit form for the benefit of newer browsers. For instance, the <a href="http://diveintohtml5.info/forms.html#placeholder">placeholder</a> attribute on the title field. The <code>placeholder</code> attribute only works on <code>&lt;input&gt;</code> elements, not <code>&lt;textarea&gt;</code>, so we can&#8217;t use it for the body.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= f.text_field :title, :class =&gt; &#39;input-xxlarge&#39;, :placeholder =&gt; &quot;Post Title&quot; %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>IE10, Firefox 4+, Safari 4+, Chrome 4+ and other modern browsers will automagically put dimmed text into the form field if it&#8217;s empty, and the text will disappear when you focus (click or tab) on the field. Older browsers ignore the attribute, which is no big whoop.</p>

<p>This is what progressive enhancement is all about. The regular <code>&lt;input&gt;</code> field works great as is; the <code>placeholder</code> attribute enhances the experience for modern browsers.</p>

<div class='note'>
  <p>If you or your client really needed `placeholder` to work everywhere and not just modern browsers, a growing class of JavaScript shims, like <a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills#web-forms--input-placeholder">these</a>, have developed to fill that need.</p>
</div>

<h4>Autofocus</h4>

<p>Here&#8217;s another enhancement: if we&#8217;d like to automatically place focus on the first form field, so the user can begin typing without needing to click into the field, the HTML5 attribute <code>autofocus</code> is ready to help:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= f.text_field :title,
</span><span class='line'>      :class =&gt; &#39;input-xxlarge&#39;,
</span><span class='line'>      :placeholder =&gt; &quot;Post Title&quot;,
</span><span class='line'>      :autofocus =&gt; true %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>Modern browsers (IE10, Firefox 4+, Safari 4+, Chrome 3+) will give that field focus when the page loads.</p>

<p>The <code>autofocus</code> behavior has traditionally been achieved with JavaScript, but using HTML5 attributes instead of JS puts the onus on the browser to give the field focus. The browser can do it faster than JavaScript can.</p>

<p>Like before, older browsers ignore the attribute; and if you need to support the behavior in all browsers, you&#8217;ll need a JavaScript fallback <a href="http://diveintohtml5.info/forms.html#autofocus">like this one</a>.</p>

<p>There are lots of <a href="http://diveintohtml5.info/forms.html">HTML5 form goodies</a> to explore, and all of them can be used to &quot;progressively enhance&quot; the user&#8217;s experience. But, we&#8217;re here for auto-saving, so let&#8217;s get to it.</p>

<h3>Hijacking the submit action and replacing it with AJAX</h3>

<p>The next step will be to hijack the form submission process so we can use AJAX to submit the form instead of a traditional page-refreshing POST request. We&#8217;ll use jQuery for cross-browser compatibility, and luckily jQuery is part of the default Rails 4 stack (it&#8217;s already in our <code>application.js</code>).</p>

<p>Check out <code>app/assets/javascripts/application.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require jquery</span>
</span><span class='line'><span class="c1">//= require jquery_ujs</span>
</span><span class='line'><span class="c1">//= require twitter/bootstrap</span>
</span><span class='line'><span class="c1">//= require_tree .</span>
</span></code></pre></td></tr></table></div></figure>

<p>Just like in our <code>application.css</code> we have a bunch of Asset Pipeline directives. jQuery, jQuery UJS, and Twitter Bootstrap are all provided by Rails Engines coming from gems. Then we have <code>require_tree .</code> which loads any JavaScript files we create.</p>

<div class='note'><p>jQuery UJS is actually maintained by the Rails project. It&#8217;s a set of jQuery plugins that Rails has helpers for. The UJS stands for &#8220;Unobtrusive JavaScript&#8221;. We&#8217;ll check it out more later.</p></div>

<p>Now it&#8217;s time to start writing our own JavaScript. Create a new file named <code>app/assets/javascripts/autosave.js</code> and open it in your editor.</p>

<p>To make sure your file is in the right place and the asset pipeline is working, let&#8217;s just output some tracing info:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;autosave.js has been loaded!&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p>Open the Console tab in your inspector, and refresh the page. You should see your console log message.</p>

<p>OK, now what we want to do is capture the submit event on our form. jQuery makes this really easy. Replace the <code>console.debug</code> line with the following code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;form is being submitted!&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>When our user presses the &quot;save&quot; button and the form is submitted, but before the data actually gets transmitted to a server, the <code>submit</code> event fires and this code catches it. However, the form still continues on to submit to the server, and we want to stop that. The event object <code>event</code> is passed into our function by jQuery, and we can disable the data transmission to the server with the <code>preventDefault</code> method of the event object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;form is being submitted!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>The user can click &quot;save&quot; until the cows come home, nothing will happen. Verify it yourself.</p>

<p>Next, let&#8217;s fire off an AJAX request to the server with the contents of the form, exactly as if the browser was doing a normal form submission. We&#8217;ll send all the same data, it&#8217;s just that we&#8217;re sending it via AJAX instead of the traditional route.</p>

<p>We&#8217;ll use jQuery&#8217;s <a href="http://api.jquery.com/jQuery.ajax/">$.ajax</a> and the following parameters:</p>

<ul>
<li><code>url</code>: the address to send the data to (the same as the <code>action</code> attribute in <code>&lt;form&gt;</code>)</li>
<li><code>type</code>: GET or POST (in our case, POST)</li>
<li><code>data</code>: the information we want to send (the content of our <code>input</code> and <code>textarea</code> fields). jQuery has a wonderful helper function, <a href="http://api.jquery.com/serialize/">.serialize()</a>, which can take a <code>&lt;form&gt;</code> element and convert it into a URL-encoded string that&#8217;s exactly what the server is expecting.</li>
<li><code>dataType</code>: the kind of data we&#8217;d like back from the server. By asking for JSON, we&#8217;re instructing the server to give us JSON back (as opposed to an HTML page or XML)</li>
</ul>

<p>Replace the <code>console.debug</code> line of code with an <code>$.ajax</code> call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="c1">// parameters go here</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Fill in the parameters:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">url</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">data</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>  <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>The form will now submit the form via an AJAX request instead of a traditional, page-refreshing request. The server is none the wiser, because it just looks like a regular old POST request. Test it yourself by creating a new post and clicking submit.</p>

<p>If you go back to the posts index page, the new post will be there.</p>

<p>But what about the human clicking &quot;save&quot;? There&#8217;s nothing telling them that the data has been sent properly, which is bad user experience. Luckily the <code>$.ajax</code> method returns a <code>$.Deferred</code> object, which allows us to easily attach some asynchronous behavior. In a synchronous language, we could just wait for the return value of <code>$.ajax</code>, but since this is asynchronous, the request is processed in the background. The deferred object lets us attach functionality to be executed later when the request is done.</p>

<p>This can be attached by chaining calls onto the end of the <code>$.ajax</code> method call, changing it from this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// parameters here</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// parameters here</span>
</span><span class='line'><span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Form submission succeeded! The server said:&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
</span><span class='line'><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorcode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Form submission failed! The server said:&quot;</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorcode</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Try it now and watch the console. Since regular users won&#8217;t be looking at the console, let&#8217;s create a simple function that displays a status message to the user, then fades out and quietly removes itself after a bit.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">notify</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">level</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// display a notification under the page header</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;alert alert-&#39;</span> <span class="o">+</span> <span class="nx">level</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">).</span>
</span><span class='line'>      <span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;.page-header&#39;</span><span class="p">).</span>
</span><span class='line'>      <span class="nx">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">).</span>
</span><span class='line'>      <span class="nx">fadeOut</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// lots of code</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now hook this up to the status and error functions, replacing the <code>console.debug</code> calls:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// parameters here</span>
</span><span class='line'><span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post failed to save.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Unobtrusive</h3>

<p>Right now our plugin is actually very unobtrusive. We didn&#8217;t have to change the form itself to enhance it into a JavaScript version, and we don&#8217;t have to include some special JavaScript lines on every page with a form to hook it all up.</p>

<p>The problem is, our code will try to attach itself to <em>any</em> form on <em>any</em> page. To remedy that, we are going to make a minor change to the form: mark it as an autosave form, and we&#8217;re going to modify our plugin: make it only attach to autosave forms.</p>

<h3>Autosave Plugin</h3>

<p>Let&#8217;s change our plugin.</p>

<p>First, store <code>$(&quot;form&quot;)</code> in a variable named <code>$form</code> so that we don&#8217;t have to repeat ourselves with our unobtrusive selector all over the place.</p>

<p>It&#8217;s common practice to name a variable with a <code>$</code> at the start when it&#8217;s a jQuery object.</p>

<p>The code changes from this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// lots of code</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// lots of code</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Next we&#8217;ll use an HTML5 Data Attribute, which can be anything we want them to be, and the browser will let us store data there. In our case, we&#8217;re saying that a <code>form</code> must have a <code>data-autosave</code> attribute. So <code>&lt;form&gt;</code> would not match the selector, but <code>&lt;form data-autosave&gt;</code> would match the selector.</p>

<p>Update the code from this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p><em>By the way:</em> this function will fail spectacularly if you don&#8217;t pass it a valid form or you pass it multiple forms. If you&#8217;d like to try something more advanced, change the line <code>var $form = $(form);</code> to only grab the first form that&#8217;s passed, or to bail out if there&#8217;s no form at all.</p>

<h3>Autosave Form</h3>

<p>If you try the form now, it will go back to a normal save, because we haven&#8217;t updated the form yet. Let&#8217;s do that now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>%= form_for @post, :html =&gt; { :class =&gt; &#39;form-horizontal&#39;, &quot;data-autosave&quot; =&gt; true } do |f| %&gt;
</span></code></pre></td></tr></table></div></figure>

<p>There we go. Now any form we mark with <code>data-autosave</code> will get our plugin, while normal forms won&#8217;t.</p>

<h3>Automatically saving when fields change</h3>

<p>Instead of only saving when the user presses the &quot;save&quot; button, we want to save when the user has changed the content of any of our fields. We can do this several ways:</p>

<ul>
<li>Attach event listeners to the <code>&lt;input&gt;</code> and <code>&lt;textarea&gt;</code> elements that only fire when the content changes</li>
<li>Use an interval timer to check the entire form every few seconds to see if something&#8217;s changed</li>
</ul>

<p>Both approaches have pros and cons. Using an interval timer is simpler JavaScript, but it means that the browser is constantly working (every few seconds, or whatever interval we set) to see if the form fields have changed. It&#8217;s not a <em>lot</em> of work, but it&#8217;s something, and especially on low-power mobile devices it&#8217;s nice to do as little work as possible.</p>

<p>However, attaching event listeners is complicated. The <code>onchange</code> event is very <a href="http://www.quirksmode.org/dom/events/index.html">widely supported</a>, but only fires when the user has clicked or tabbed <em>out</em> of a field. Spending a few hours typing in one <code>&lt;textarea&gt;</code>, without clicking or tabbing elsewhere, will yield exactly zero <code>onchange</code> events.</p>

<p>We could look for the <code>keypress</code> event, which can be bound to the form, and that&#8217;s a fine answer. Every time a key is pressed, it fires. Hooray! We&#8217;d also need to throttle or <a href="http://unscriptable.com/2009/03/20/debouncing-javascript-methods/">debounce</a> the user input. We wouldn&#8217;t want an AJAX request sent <em>every single time</em> the user types a key. We&#8217;d want it sent every few seconds (or longer).</p>

<p>But if we entered content without using the keyboard (say, right-clicking and pasting, or through speech recognition), the <code>keypress</code> event won&#8217;t fire. There&#8217;s also a newer HTML5 <code>input</code> event, which fires when content changes no matter the source, but it&#8217;s a bit buggy and unsupported on <a href="http://whattheheadsaid.com/2010/09/effectively-detecting-user-input-in-javascript">older browsers.</a></p>

<p>In this tutorial, we&#8217;ll go with <code>setInterval</code>, because it&#8217;s more straightforward to implement. We&#8217;ll poll the page every 10 seconds to see if something has changed, and if it has, we&#8217;ll save the form. The &quot;save&quot; button will also work normally.</p>

<h3>Abstracting the Save Functionality</h3>

<p>First, we need to abstract our &quot;saving&quot; code into its own function, so it&#8217;s not just called when the form is manually submitted.</p>

<p>Find the <code>$.ajax</code> call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// lots of code</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Copy it into a new function called saveForm():</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">saveForm</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="c1">// lots of code</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The file now looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">notify</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveForm</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>In <code>saveForm()</code> there are references to <code>$(this)</code> which won&#8217;t be pointing to the right thing anymore. Replace <code>$(this)</code> with <code>$form</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">saveForm</span><span class="p">(</span><span class="nx">$form</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally, we need to call the <code>saveForm()</code> inside the submit handler for our form:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>autosave.js</code> should now be structured like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">notify</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveForm</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Polling for Changes</h3>

<p>With the &quot;saving&quot; function in place, let&#8217;s create a function that will check the form and save it if it&#8217;s changed. We could loop through each of the <code>&lt;input&gt;</code> fields, but we&#8217;d need to make sure we got any <code>&lt;textarea&gt;</code> elements (or <code>&lt;select&gt;</code> elements, etc.). Instead, let&#8217;s use that good old <code>.serialize()</code> function that converts all of the form fields into a string for us. Then it&#8217;s a simple string comparison.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">notify</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveForm</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveFormIfChanged</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>The implementation of <code>saveFormIfChanged()</code> is as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">saveFormIfChanged</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>See what&#8217;s happening here? The contents of the form are being converted into a string with <code>.serialize()</code> and we&#8217;re testing whether it&#8217;s equivalent to <code>savedForm</code>, which is the earlier version of the form fields we already saved. Wait, what earlier version? Oh, right! We need to make an earlier version when the page loads! So we&#8217;ll need to add in our <code>onready</code> block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>

<p>Again, this will fail miserably if there&#8217;s more than one form on the page! We&#8217;re staying simple for now.</p>

<div class="note"><p>JavaScript allows you to share variables inside the same scope. That means that since we defined our `savedForm` variable inside the same scope (the `onready`) as our helper functions, they can access it. The `onready` has created a &#8220;Closure&#8221; around this code, providing a scope to share. This is what happens with any function in JavaScript. The same thing is happening with `$form`. It&#8217;s effectively a global variable, but only within our local scope. Cool!</p></div>

<p>Finally, we&#8217;ll set up the interval timer to check every 10 seconds. <code>Window.setInterval</code> is set in milliseconds, so 10 seconds * 1000 milliseconds = 10,000 milliseconds.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">autosaveInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">saveFormIfChanged</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p>Try it out! Watch the console (or the message) and make sure the form is automatically saving every ten seconds if something has changed.</p>

<p>With our working auto-saver in place, we could remove the &quot;save&quot; button entirely, since we no longer technically need it. In the real world, this might be bad UX, as users may expect a &quot;save&quot; button and become disoriented when they can&#8217;t find it. Instead of doing that, let&#8217;s restore the button to its original state, and let the form submit normally when the user clicks &quot;save.&quot; We do this by removing the <code>$form.on('submit')</code> block.</p>

<p>Now the form saves automatically, but when the user clicks &quot;save,&quot; it&#8217;s saved one more time, the normal POST way, and the user is taken to the target page.</p>

<h3>Refactor</h3>

<p>Let&#8217;s move all the variable assignments to the top of the <code>onready</code> block.  With that change, here&#8217;s our entire block of code as it stands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">autosaveInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">saveFormIfChanged</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">notify</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">level</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// display a notification under the page header</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;alert alert-&#39;</span> <span class="o">+</span> <span class="nx">level</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">).</span>
</span><span class='line'>      <span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;.page-header&#39;</span><span class="p">).</span>
</span><span class='line'>      <span class="nx">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">).</span>
</span><span class='line'>      <span class="nx">fadeOut</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveForm</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span>
</span><span class='line'>    <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post failed to save.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveFormIfChanged</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Solving problems and handling errors</h3>

<p>This implementation is pretty fragile, though, and we need to toughen it up to solve a couple of problem scenarios.</p>

<h4>Problem Scenario: The user navigates away without saving</h4>

<p>If the user clicks the back button, or otherwise goes away without hitting &quot;save,&quot; their changes will be lost. The JavaScript <code>unload</code> event handler is useful to us here. (Alternatively, we could use the <code>beforeunload</code> event, which lets us throw up an &quot;Are you sure you want to navigate away from this page?&quot; alert box, giving the user the opportunity to cancel. But for now we&#8217;ll just use <code>unload</code>.) The <code>unload</code> event fires on the window when the user is attempting to navigate away. When that happens, we&#8217;ll go ahead and save the form right then.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;unload&#39;</span><span class="p">,</span> <span class="nx">saveFormIfChanged</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p>There are two problems with this. The first problem is that the AJAX request is firing asynchronously, which means the browser won&#8217;t stick around to wait for an answer. That&#8217;s no good. Thankfully, changing the AJAX request to be synchronous (the opposite) is as easy as setting <code>async</code> to false in our <code>$.ajax</code> request. Rather than writing the <code>$.ajax</code> request all over again, let&#8217;s reuse the <code>saveFormIfChanged</code> function but add a hook so we can specify if the request should be asynchronous or not.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">saveForm</span><span class="p">(</span><span class="nx">async</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">saveForm</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post failed to save.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Our <code>window.unload</code> event listener can now pass a flag to say that the request should be synchronous (setting <code>async</code> to <code>false</code> instead of the default <code>true</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Delightful! First problem solved. Our second problem is when the user legitimately hits the &quot;submit&quot; button. The <code>unload</code> event is still fired, which means we&#8217;re saving the form twice — once through the AJAX call, and once through the normal POST. That&#8217;s wasteful. There are a couple of ways around this. Here&#8217;s one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>This puts the current state of the form into the global <code>savedForm</code> variable. The <code>unload</code> event will still fire, but <code>isFormChanged()</code> will return <code>false</code> because the form contents will be identical to what&#8217;s on the page.</p>

<p>Another way to solve the problem would be to remove the <code>unload</code> event listener entirely when the form is submitted.</p>

<h4>Problem Scenario: The AJAX request fails or stops working</h4>

<p>If our AJAX request comes back with an error — let&#8217;s say a cross-site scripting error, or a strange server bug, or a timeout because the user is temporarily offline, we need to handle that error with grace. Right now we&#8217;re outputting the error message &quot;Post failed to save&quot; to the user, which isn&#8217;t very helpful and sounds a little scary. (It failed? What do I do now?)</p>

<p>Instead, let&#8217;s have an AJAX failure happen quietly, but if it happens, let&#8217;s <em>remove the auto-saving feature from the page entirely,</em> reverting to the standard form submission. That way if there&#8217;s an error, our JavaScript will get the heck out of there and let the browser do things normally rather than breaking the experience entirely.</p>

<p>So, let&#8217;s create a function that does that cleanup work in the event of an error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">formError</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">autosaveInterval</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$form</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>And let&#8217;s fire that function if there&#8217;s an error in <code>saveForm</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">saveForm</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="nx">formError</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;ve added some significant flexibility and robustness to this script!</p>

<h3>Next steps</h3>

<ul>
<li>Remove the form from the page. What happens? What happens if there are two forms on the page?</li>
<li>Instead of a notification above the form button, change the text of the button itself to temporarily say &quot;Saved!&quot; instead of &quot;Save&quot; every time there&#8217;s an automatic save. Check out <a href="http://twitter.github.io/bootstrap/javascript.html#buttons">Twitter Bootstrap&#8217;s JavaScript Button Plugin</a>.</li>
<li>Add a &quot;loading&quot; or &quot;progress&quot; graphic when the ajax request is fired and remove it when the request is answered. (Use the <code>beforeSend</code> and <code>complete</code> <a href="http://api.jquery.com/jQuery.ajax/#callback-functions">callbacks</a>, and an <a href="http://www.ajaxload.info/">animated GIF graphic</a> or <a href="http://twitter.github.io/bootstrap/components.html#progress">Twitter Bootstrap&#8217;s Animated Progress Bar</a>.)</li>
</ul>

<h3>Ready for even more?</h3>

<ul>
<li>Use the <code>keypress</code> (or <code>keyup</code> or <code>keydown</code> event) along with <code>paste</code> to trigger saves only when the user is typing in fields</li>
<li>Add a &quot;cancel&quot; button that reverts the saved data to the its original state (this can be done solely in JavaScript, btw)</li>
<li>Also save the latest version in the browser&#8217;s LocalStorage, so the data will survive browser crashes (<a href="https://github.com/simsalabim/sisyphus">Hint 1</a> <a href="http://www.codediesel.com/javascript/auto-save-your-web-form-data/">Hint 2</a>)</li>
<li>Extract our implementation into a <a href="http://learn.jquery.com/plugins/basic-plugin-creation/">jQuery plugin</a></li>
</ul>

<h2>5. Unit Testing with Konacha</h2>

<p>Our autosave script works pretty well, but there&#8217;s one down side: we have to click through all possible scenarios to make sure they&#8217;re all working whenever we make a change. It&#8217;s just getting to the point by the end of the last section when it starts to feel painful or annoying. And imaging how you&#8217;d feel if you were brought on to improve this code, and you weren&#8217;t familiar with it!</p>

<p>Unit testing has been around for decades, and JavaScript unit testing isn&#8217;t that new either. JsUnit is one of the oldest frameworks and <a href="https://github.com/pivotal/jsunit/commit/40c9cbf0f6498eeee81250fc2b01adf1c2bc07b2">it&#8217;s been around for 12 years</a>.</p>

<p>Recently, a new Ruby gem called <a href="https://github.com/jfirebaugh/konacha">Konacha</a> came along with the express intent to support JavaScript Unit Testing in Rails. This is really helpful, because before we&#8217;d have to do a lot of extra work to integrate a pure JavaScript engine into the Asset Pipeline, plus create Rake tasks to run our tests for us.</p>

<p>Konacha didn&#8217;t start from scratch. It includes the <a href="http://visionmedia.github.io/mocha/">Mocha</a> testing framework for describing and running tests, and it includes the <a href="http://chaijs.com/">Chai</a> assertion library for checking code behavior.</p>

<p>So, Konacha is the glue that binds Mocha and Chai to the Rails Asset Pipeline and provides Rake tasks for continuous integration. Sounds amazing (and also delicious) so let&#8217;s see how it works.</p>

<h3>Konacha Setup</h3>

<p>First off, we need to bring in the gem, just like we did with <code>twitter-bootstrap-rails</code>. Open up <code>Gemfile</code> and add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;konacha&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;selenium-webdriver&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Since these are our first development- and test-only gems, I added it at the bottom of my gemfile, away from the core gems.</p>

<p>We are also adding the <code>selenium-webdriver</code> gem. This will allow us to run the Konacha tests in an automated browser. You can also use the <code>poltergeist</code> gem and configure Konacha to use <code>poltergeist</code>, which runs on <code>phantomjs</code>, which is a headless browser (meaning there is no gui). We can do this later as an exercise.</p>

<p>Now, we need to bundle our app to bring in the new gems:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle</span><span class='line output'>Fetching gem metadata from https://rubygems.org/..........</span><span class='line output'>Fetching gem metadata from https://rubygems.org/..</span><span class='line output'>Resolving dependencies...</span><span class='line output'>... lots of gems ...</span><span class='line output'>Installing colorize (0.5.8)</span><span class='line output'>Installing konacha (3.0.0)</span><span class='line output'>Installing ffi (1.8.1)</span><span class='line output'>Installing childprocess (0.3.9)</span><span class='line output'>Installing rubyzip (0.9.9)</span><span class='line output'>Installing websocket (1.0.7)</span><span class='line output'>Installing selenium-webdriver (2.33.0)</span><span class='line output'>... more gems ...</span><span class='line output'>Your bundle is complete!</span><span class='line output'>Use `bundle show [gemname]` to see where a bundled gem is installed.</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now we can boot our Konacha test suite:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:serve</span><span class='line output'>Your tests are here:</span><span class='line output'>http://localhost:3500/</span><span class='line output'>[2013-06-02 12:53:10] INFO  WEBrick 1.3.1</span><span class='line output'>[2013-06-02 12:53:10] INFO  ruby 2.0.0 (2013-02-24) [x86_64-linux]</span><span class='line output'>[2013-06-02 12:53:10] WARN  TCPServer Error: Address already in use - bind(2)</span><span class='line output'>[2013-06-02 12:53:10] INFO  WEBrick::HTTPServer#start: pid=14804 port=3500</span></code></pre></td></tr></table></div></div>
        </div>

<p>As you can see on the last line, it&#8217;s running on port 3500, so let&#8217;s open up <a href="http://localhost:3500">localhost:3500</a>.</p>

<p>The page is almost empty. Up in the top right it says we have 0 passes and 0 failures. That&#8217;s because we have no tests! First, let&#8217;s create our test directory:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>mkdir -p spec/javascripts</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now let&#8217;s make a test file to ensure Konacha is all hooked up. Edit <code>spec/javascripts/is_it_working_spec.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;My Application&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should think that true is true&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kc">true</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Of course, this should fail, because false isn&#39;t true</span>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should think that false is true&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kc">false</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now refresh your browser that is pointed to Konacha. It should show one pass and one failure. Now we&#8217;re cooking with gas!</p>

<p>The <code>describe</code> and <code>it</code> functions are coming from Mocha. They let us separate tests into different sections (with <code>describe</code>) and into separate tests (with <code>it</code>).</p>

<p>The <code>should.equal</code> is coming from Chai. Chai actually has three different styles, and you can pick the one that works for you best:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kc">true</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'><span class="nx">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'><span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;ll be using the <code>should</code> style, as that is closest to <code>rspec</code>, a very popular Rails testing framework.</p>

<p>Konacha also comes with a command line runner. Let&#8217;s try running it:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:run</span><span class='line output'>.F</span><span class='line output'></span><span class='line output'>Failed: My Application should think that false is true</span><span class='line output'>AssertionError: expected false to equal true</span><span class='line output'></span><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>2 examples, 1 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>It pops up a Firefox instance using Selenium, hits our tests, and then reformats the output for the console. If we were using <code>poltergeist</code>, no window would pop up.</p>

<p>It&#8217;s up to you if you&#8217;d rather use the browser or command line version. For the rest of the tutorial, we&#8217;ll use the command line, just because it&#8217;s easier to include the output here.</p>

<p>Finally, remove this test, as it doesn&#8217;t really do anything:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rm spec/javascripts/is_it_working_spec.js</span></code></pre></td></tr></table></div></div>
        </div>

<h2>6. Testing Notifications</h2>

<p>When you&#8217;re unit testing, it&#8217;s often easier to work bottom-up. That means starting with the smallest and most isolated chunk of code first. That way you have to do the least amount of setup and teardown. So the first thing we&#8217;re going to test are our notification messages, since those are very simple.</p>

<p>Let&#8217;s look at our notification code again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">notify</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">level</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// display a notification under the page header</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;alert alert-&#39;</span> <span class="o">+</span> <span class="nx">level</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">).</span>
</span><span class='line'>    <span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;.page-header&#39;</span><span class="p">).</span>
</span><span class='line'>    <span class="nx">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">).</span>
</span><span class='line'>    <span class="nx">fadeOut</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>When we&#8217;re going to test something, we need to know two important things: what does this code need (its dependencies), and who does it collaborate with?</p>

<p>Since it&#8217;s a function, what it needs is pretty simple: a <code>message</code> and optionally a <code>level</code>.</p>

<p>Who does it collaborate with is a little trickier: it collaborates with the <code>.page-header</code> since all it does is add a message to the top of the page.</p>

<p>What we need are some HTML fixture. An HTML fixture is a small chunk of HTML that will give us the necessary elements on the page for our code to interact with. We&#8217;ll implement them as test templates so they play nice with the Rails Asset Pipeline.</p>

<p>First, make a directory for our templates:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>mkdir spec/javascripts/templates</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now let&#8217;s make a template for our notification system. Since all it needs is a page header, we&#8217;ll put that in.</p>

<p>Edit <code>spec/javascripts/templates/page_header.jst.ejs</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;page-header&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>So what&#8217;s the <code>.jst.ejs</code>? JST stands for JavaScript Template, which is a common format for making templates. It means that <code>templates/page_header.jst</code> should be accessible as a function at <code>JST[&quot;templates/page_header&quot;]</code> and if we call that function, it will evaluate the template.</p>

<p>Just like how <code>.html.erb</code> files is HTML that is evaluated by ERB (to include ruby snippets), <code>.jst.ejs</code> is a JST template that is evaluated by EJS (Embedded JavaScript), which is a template compiler for Ruby.</p>

<p>That means we need the <code>ejs</code> gem. Let&#8217;s add it to our Gemfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;konacha&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;selenium-webdriver&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;ejs&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>OK, we have a template, now we can write our first test. Open up <code>spec/javascripts/notification_spec.js</code> and put:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//=require application</span>
</span><span class='line'><span class="c1">//=require_tree ./templates</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;notification&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should put a message on the page header&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;templates/page_header&#39;</span><span class="p">]());</span>
</span><span class='line'>    <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/hello world/</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Let&#8217;s walk through it. First off, we have some Asset Pipeline directives to load our application. This pulls in <code>application.js</code>, which pulls in all our framework code. Next we are loading the <code>./templates</code> tree. We don&#8217;t want our test templates to be part of our app, so that&#8217;s why we put them into <code>spec/javascripts/templates</code>. That also means we have to load them specifically into this test case.</p>

<p>Next up, we&#8217;re <code>describe</code>ing <code>notification</code>, and saying that <code>it</code> should put a message on the page header.</p>

<p>The first thing this test does is replace the body of the page with our template. Konacha runs each test in an iframe so that we have a nice clean page for each test, and we can mess up the body all we want. Note that we have to call the template as a function to get the evaluated contents.</p>

<p>Then, we call <code>notify(&quot;hello world&quot;)</code>. That should put a &quot;hello world&quot; message on the page header.</p>

<p>Finally, we grab the page header&#8217;s text and we ensure that it matches <code>/hello world/</code>. We use a match and a regular expression because we don&#8217;t care about whitespace.</p>

<p>Reload your Konacha suite, and you should see a failure:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:run</span><span class='line output'>F</span><span class='line output'></span><span class='line output'>Failed: notify should put a message on the page header</span><span class='line output'>ReferenceError: notify is not defined</span><span class='line output'></span><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>1 examples, 1 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>We get an error because <code>notify</code> is not defined. That&#8217;s because it&#8217;s inside our <code>onready</code>&#8217;s closure. Notify doesn&#8217;t need to be in there, since it&#8217;s pretty much a global helper.</p>

<p>Edit <code>autosave.js</code> and move the <code>notify</code> function outside of the closure. Rerun the test and it should pass.</p>

<p>Cool, our first working test! There&#8217;s a saying in the Test Driven Development world: &quot;Red, green, refactor!&quot;. That means the first thing you do is write a test that fails. We did that by writing our test, and it failed because the <code>notify</code> method was not globally available.</p>

<p>Then, we went &quot;green&quot; by fixing our code so the test passed. Now it&#8217;s time for &quot;refactor&quot;. That means we&#8217;re going to clean up our code and use our test to make sure it still works.</p>

<p>Move the <code>notify</code> function into it&#8217;s own file: <code>app/assets/javascripts/notification.js</code>. Re-run your tests to make sure it is still passing.</p>

<p>Great, now we&#8217;ve tested <code>notify</code>&#8217;s basic case. Let&#8217;s test the levels. In this case we won&#8217;t have a &quot;red&quot; phase because our code already has levels. If we were TDDing, we would write the test before we wrote the code to handle levels. But for now we&#8217;re testing existing code.</p>

<p>First, let&#8217;s test that the default level is info by adding a new <code>it</code> statement:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should default to the info level&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;templates/page_header&#39;</span><span class="p">]());</span>
</span><span class='line'>  <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header .alert&quot;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;alert-info&quot;</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Our first two lines are the same. The third line checks that the alert div we create has the <code>alert-info</code> class on it. Check your tests. Now there will be two lines, one for each <code>it</code>, and they should both pass.</p>

<p>Let&#8217;s refactor, but this time we&#8217;ll refactor our tests, since the first two lines are the same. We can do this with Mocha&#8217;s <code>beforeEach</code> function. Check it out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;notification&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;templates/page_header&#39;</span><span class="p">]());</span>
</span><span class='line'>    <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should put a message on the page header&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/hello world/</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should default to the info level&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header .alert&quot;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;alert-info&quot;</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>beforeEach</code> will get run before each test, so they can share a setup. Now let&#8217;s add a test for error levels. But there&#8217;s one problem: we want to make a different <code>notify</code> call, but that would conflict with the one we&#8217;re making already. So what we have to do is create two nested <code>describe</code> methods, one for the <code>info</code> level, and one for the error level:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;notification&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;templates/page_header&#39;</span><span class="p">]());</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;info level&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should put a message on the page header&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/hello world/</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should default to the info level&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header .alert&quot;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;alert-info&quot;</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;error level&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should make error messages&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;everything is terrible&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header .alert&quot;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;alert-error&quot;</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests to make sure everything is passing. If they seem to be passing but no tests actually ran, you have a syntax error somewhere:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>0 examples, 0 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>Let&#8217;s walk through the code. At the top, we have a <code>beforeEach</code> that sets up our template, as that&#8217;s shared across all kinds of notifications.</p>

<p>Then, we have a <code>describe</code> for the <code>info level</code> that has a <code>beforeEach</code> that makes an info level notification. This is where our previous tests are.</p>

<p>Finally, we have a <code>describe</code> for <code>error level</code> that has our single error test. Note that I didn&#8217;t make a <code>beforeEach</code> here. I like to only extract code into setups when I have to, that way the code is as lean as it can be.</p>

<div class="note"><p>
At this point, you may be looking at all the `it`s and `describes` and all the `});`s and thinking the code looks pretty ugly and full of syntactical necessities. I&#8217;d like to point out that a lot of the Rails and JavaScript community is moving towards using CoffeeScript, because of its simplifying effect on the syntax of JavaScript. Here&#8217;s what the tests look like as CoffeeScript:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">describe</span> <span class="s2">&quot;notification&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nx">beforeEach</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s2">&quot;templates/page_header&quot;</span><span class="p">]())</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">describe</span> <span class="s2">&quot;info level&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nx">beforeEach</span> <span class="o">-&gt;</span> <span class="nx">notify</span> <span class="s2">&quot;hello world&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span> <span class="s2">&quot;should put a message on the page header&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/hello world/</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span> <span class="s2">&quot;should default to the info level&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header .alert&quot;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;alert-info&quot;</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nx">describe</span> <span class="s2">&quot;error level&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nx">it</span> <span class="s2">&quot;should make error messages&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nx">notify</span> <span class="s2">&quot;everything is terrible&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header .alert&quot;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;alert-error&quot;</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>

<p>But that&#8217;s a class all on its own!
</p></div></p>

<h2>7. Unit Test Autosave</h2>

<p>OK, we extracted out <code>notify</code>, now it&#8217;s time to work on our main autosave script. First let&#8217;s setup our new test file, <code>spec/javascripts/autosave_spec.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require spec_helper</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;autosave&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>This time, I&#8217;m <code>require</code>ing <code>spec_helper</code>. I don&#8217;t want to copy and paste the <code>require</code> lines from <code>notification_spec</code> since that would duplicate the &quot;what our tests need to run&quot; functionality. Instead, make <code>spec/javascripts/spec_helper.js</code> and simply add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require application</span>
</span><span class='line'><span class="c1">//= require_tree ./templates</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then go to <code>notification_spec.js</code> and change those two lines to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require spec_helper</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now we have a shared space to make setting up tests easier. Rerun your tests to make sure you&#8217;ve wired everything together correctly.</p>

<h3>Testing Save</h3>

<p>The easiest and simplest course of action here is to work bottom up. We have these behaviors we need to test:</p>

<ol>
<li>Binding to a form on page load</li>
<li>Saving on an interval</li>
<li>Saving on page <code>unload</code></li>
<li>Saving</li>
<li>Saving if there&#8217;s a change</li>
<li>Unbinding on an error</li>
</ol>

<p>Many of these functions call <code>saveForm</code>, and <code>saveForm</code> has three dependencies:</p>

<ol>
<li><code>notify</code></li>
<li><code>$form</code></li>
<li><code>$.ajax</code></li>
</ol>

<p>Notify is already tested, so that should be easy, because we won&#8217;t have to make sure it works. <code>$form</code> means that we&#8217;ll need a template for an autosaving form, which we can do pretty easily. <code>$.ajax</code> is tricky because we need a whole rails server to make sure it works. Luckily, there&#8217;s <code>sinon.js</code>.</p>

<h4>Sinon</h4>

<p>Sinon is another JavaScript test framework, and it has a bunch of helpful code surrounding Test Spies and it also contains a Fake Server. Sinon has a rails gem, but it&#8217;s a bit out of date, so we get to learn how to bring in our own JavaScript without a gem. It&#8217;s actually pretty easy.</p>

<p>Visit <a href="http://sinonjs.org">sinonjs.org</a> and download sinon.js into <code>vendor/assets/javascripts/sinon-1.7.1.js</code> (your version number may be slightly different, remember it for the next step).</p>

<p>Now open up <code>spec/javascripts/spec_helper.js</code> and add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require sinon-1.7.2</span>
</span></code></pre></td></tr></table></div></figure>

<p>You should be able to run your tests and they should still pass. It&#8217;s always good to check!</p>

<h4>The test</h4>

<p>Now it&#8217;s time to write our test. Remember, we&#8217;re going to write what we expect to work, then implement what we need to in order to get it to pass. Here&#8217;s our test for <code>saveForm</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require spec_helper</span>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;autosave&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;saveForm&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">server</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">server</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">fakeServer</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">server</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should save a form via ajax&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;templates/autosave_form&#39;</span><span class="p">]());</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">request</span><span class="p">.</span><span class="nx">requestBody</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;title=My+Post+Title&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">request</span><span class="p">.</span><span class="nx">respond</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Post saved/</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Like before, we have describe blocks and a <code>beforeEach</code>, but now we also have a variable in the describe block, and an <code>afterEach</code>. What we&#8217;re doing here is making the <code>server</code> variable available to the whole describe block. Setting it in <code>beforeEach</code>, then tearing it down in <code>afterEach</code>. Since sinon is going to hijack the entire XHR object of the browser, we need to make sure it gets cleaned up.</p>

<p>In our test, we set up our fixture as usual. But then we&#8217;re calling <code>$(&quot;form&quot;).autosave(&quot;save&quot;)</code>.</p>

<p>Shouldn&#8217;t this work?</p>

<p>The issue here is like with <code>notify</code> the method is part of the closure. In fact, all our code is closed up and inaccessible to anyone who wants to use it. This makes it hard to test, but really it&#8217;s just because it&#8217;s hard to use.</p>

<p>Take, for example, what would happen if we used JavaScript to build a form on-the-fly. Since we bind to forms when the page loads, this new dynamic form wouldn&#8217;t get the autosaving functionality. jQuery plugins exist so that you can run custom code on objects on the fly. What you&#8217;re seeing now is a common jQuery plugin syntax for sending a command (<code>save</code>) to an object via a plugin.</p>

<p>So what I&#8217;m doing here is writing a test for how I <em>wish</em> the application worked. This fails, and we&#8217;re going to write what we need to make it pass, and the code will be more awesome for it.</p>

<p>Next, we grab the server&#8217;s first request, which is a fake XHR request. We make sure that it is posting to the right url, and that it has the right data being sent along. Then we tell it to respond, which will call back to jQuery. Finally, we make sure the success message is present on the page.</p>

<p>If we run our tests, we get:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:run</span><span class='line output'>F...</span><span class='line output'></span><span class='line output'>Failed: autosave saveForm should save a form via ajax</span><span class='line output'>TypeError: JST['templates/autosave_form'] is not a function</span><span class='line output'></span><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>4 examples, 1 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>So, let&#8217;s make <code>spec/javascripts/templates/autosave_form.jst.ejs</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;page-header&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;form</span> <span class="na">data-autosave=</span><span class="s">&quot;autosave&quot;</span> <span class="na">action=</span><span class="s">&quot;/posts&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">value=</span><span class="s">&quot;My Post Title&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now if we run our tests, we get:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:run</span><span class='line output'>F...</span><span class='line output'></span><span class='line output'>Failed: autosave saveForm should save a form via ajax</span><span class='line output'>TypeError: $("form").autosave is not a function</span><span class='line output'></span><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>4 examples, 1 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>So, the first thing we need to do is make a jQuery plugin. We&#8217;re not going to write all the code to do that write now. Instead, we&#8217;re going to write the <em>least code necessary</em> to proceed past this failure.</p>

<p>Add this to the top of <code>autosave.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>That is the skeleton of a jQuery plugin called <code>autosave</code>. Now our tests say:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:run</span><span class='line output'>F...</span><span class='line output'></span><span class='line output'>Failed: autosave saveForm should save a form via ajax</span><span class='line output'>TypeError: request is undefined</span><span class='line output'></span><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>4 examples, 1 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>That&#8217;s because our plugin doesn&#8217;t do anything! What we need to do now is move our initialization code into the plugin. Our code now looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">autosaveInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">saveFormIfChanged</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">saveForm</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="nx">formError</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">saveForm</span><span class="p">(</span><span class="nx">$form</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">formError</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">autosaveInterval</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$form</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>Instead of the <code>$()</code> <code>onready</code> we moved that code into the plugin. We are still getting the same test error, because when we pass the <code>&quot;save&quot;</code> option to the plugin we expect it to call <code>saveForm</code>. Let&#8217;s do that now.</p>

<p>First, at the top, we will accept a command argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then, at the very bottom <strong>but inside the plugin</strong> we&#8217;ll call <code>saveForm</code> if the command is <code>save</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;save&quot;</span><span class="p">)</span> <span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>And voila, our tests pass. However there is one problem: every time we run a command like this, we&#8217;re running all our plugin&#8217;s binding code. Also, we aren&#8217;t binding on page load, so our actual implementation is failing! Since we messed with the structure of the plugin itself, it&#8217;s good to check it out in a real browser to make sure that things went well.</p>

<p>Let&#8217;s move the autosave selector into its own onready:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="c1">// middle unchanged</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>When the page is loaded, we&#8217;ll run our autosave plugin on all forms that match the autosave data attribute. This also allows us to call <code>$(&quot;form&quot;).autosave()</code> in our test after the page has loaded.</p>

<p>Now let&#8217;s mark the form as autosaving once we&#8217;ve loaded our plugin, and then we won&#8217;t reinitialize it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">autosaving</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">autosaving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// the rest of the code</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;save&quot;</span><span class="p">)</span> <span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, we mark the dom element with an <code>autosaving</code> attribute. When our JavaScript hits this element again, it won&#8217;t initialize the form.</p>

<h3>Testing <code>saveFormIfChanged</code></h3>

<p>The next thing we can test is <code>saveFormIfChanged</code>. This will be pretty simple, because all we&#8217;ll do is tell the form to save twice, and make sure only one save goes through. Then, we&#8217;ll change the content and tell it to save again.</p>

<p>Move the template code into the <code>beforeEach</code>, then add this <code>it</code> case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should only save if values have changed&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">server</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">&quot;A different title&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">server</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you run the tests, we get an error <code>TypeError: Cannot call method 'attr' of undefined</code> from the <code>saveForm</code> method. Our double-initialization checking code is actually preventing the plugin from keeping the <code>$form</code> variable around.</p>

<p>What we need to do is get a form reference and define the functions, but we don&#8217;t want to bind events that are already bound. Since this change effects a couple sections of the code, here&#8217;s the refactored code, for clarity&#8217;s sake:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">form</span><span class="p">.</span><span class="nx">autosaving</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">autosaving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">saveForm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>            <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>            <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span>
</span><span class='line'>          <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">formError</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">saveFormIfChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">form</span><span class="p">.</span><span class="nx">saveForm</span><span class="p">(</span><span class="nx">$form</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">formError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">autosaveInterval</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">$form</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">autosaveInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;save&quot;</span><span class="p">)</span> <span class="nx">form</span><span class="p">.</span><span class="nx">saveForm</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>What we&#8217;ve done is defined all our functions and variabled on the dom element itself. That means any time we visit this element again (subsequent calls to <code>autosave</code>) we can call the functions we set up for ourselves, and use the variables we set up too. (Also note I had to move the <code>setInterval</code> call down until after <code>saveFormIfChanged</code> was defined.)</p>

<p>We&#8217;re slowly working our way towards a more Object Oriented version of our plugin. Instead of a bag of functions and variables, we have a form object that has methods on it.</p>

<p>At this point, our test gives us:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rake konacha:run</span><span class='line output'>.F...</span><span class='line output'></span><span class='line output'>Failed: autosave saveForm should only save if values have changed</span><span class='line output'>AssertionError: expected 2 to equal 1</span><span class='line output'></span><span class='line output'>Finished in 0.00 seconds</span><span class='line output'>5 examples, 1 failed, 0 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>Great! Now the only issue is the one under test: we are double saving. It&#8217;s a simple fix. Just change the command line to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;save&quot;</span><span class="p">)</span> <span class="nx">form</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>

<p>But now, our first test failed! It turns out, that test wasn&#8217;t as specific as it needed to be. Because our form only saves when there is a change, we need to make a change before trying to save (we could wait for the timeout, but who has time for that?):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require spec_helper</span>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;autosave&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;saveForm&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">server</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">server</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">fakeServer</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;templates/autosave_form&#39;</span><span class="p">]());</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">server</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should save a form via ajax&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">&quot;A different title&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">request</span><span class="p">.</span><span class="nx">requestBody</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;title=A+different+title&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">request</span><span class="p">.</span><span class="nx">respond</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.page-header&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Post saved/</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s2">&quot;should only save if values have changed&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">server</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">&quot;A different title&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">server</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>We initialize in the <code>beforeEach</code>, and then before we want a real save, we change the text in the form. Everything is passing, yay!</p>

<h2>8. Fully Object Oriented</h2>

<p>My favorite part of TDD is refactoring into a great solution, with your tests confirming that everything is working. It&#8217;s time to make this code really clean and object oriented.</p>

<h3>JavaScript OO Crash Course</h3>

<p>Let&#8217;s do a quick overview of objects in JavaScript. JavaScript uses prototypical inheritance, which means if you give a function a prototype, it can be constructed. Here&#8217;s an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">Person</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">sayHello</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hi, I&#39;m &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">(</span><span class="s2">&quot;Joe&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">joe</span><span class="p">.</span><span class="nx">sayHello</span><span class="p">()</span> <span class="c1">// alerts &quot;Hi, I&#39;m Joe&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>The function is the constructor, then any method on the prototype will have <code>this</code> set to the instance it&#8217;s being called on.</p>

<h3>OO Autosave</h3>

<p>As we go through our OO refactor, be sure to run the tests at every step (I&#8217;ll remind you) to make sure everything is ok so far.</p>

<p>The first thing we&#8217;re going to do is move the bulk on the code into the constructor, and we&#8217;ll extract the methods later:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">AutosaveForm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">form</span><span class="p">.</span><span class="nx">saveForm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">formError</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">form</span><span class="p">.</span><span class="nx">saveFormIfChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">saveForm</span><span class="p">(</span><span class="nx">$form</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">form</span><span class="p">.</span><span class="nx">formError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">autosaveInterval</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$form</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">form</span><span class="p">.</span><span class="nx">autosaveInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">AutosaveForm</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">form</span><span class="p">.</span><span class="nx">autosave</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutosaveForm</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;save&quot;</span><span class="p">)</span> <span class="nx">form</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>All I really did was pass the <code>form</code> through to the constructor, and then define all the methods in the constructor. It still puts all the methods back onto the dom element. The tests are still passing.</p>

<p>The next thing we&#8217;re going to do is store the <code>form</code> and <code>$form</code> on <code>this</code> in the constructor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">AutosaveForm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">form</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="nx">form</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">$form</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// the rest is the same</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, we&#8217;ll move each function into the prototype, and put our instance variables on <code>this</code>, and call the other form functions using <code>this</code>. For example, here&#8217;s <code>formError</code> moved over:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">AutosaveForm</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">formError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">autosaveInterval</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">$form</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

<p>Try to move them all over yourself. One of the biggest issues will be function scope. For example, the <code>fail</code> handler on <code>$.ajax</code> in <code>saveForm</code> can&#8217;t take <code>this.formError</code> as a parameter, because when <code>formError</code> gets called, it won&#8217;t be in the scope of the autosaving form instance, it will be called on window. So you&#8217;ll need to store the scope:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">autosaveForm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">autosaveForm</span><span class="p">.</span><span class="nx">formError</span><span class="p">()</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>Storing a reference to <code>this</code> in a variable and then using that variable later is a common pattern in JavaScript. Often, people will say <code>var self = this</code> or <code>var that = this</code>.</p>

<p>An alternative is underscore.js&#8217;s <code>bind</code>. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">fail</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formError</span><span class="p">,</span> <span class="k">this</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<p>That will create a function that just calls <code>formError</code> on the <code>this</code> passed in.</p>

<p>Here is a complete implementation. Note that I had to use a <code>this</code> reference multiple times in the initializer to keep scope.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">AutosaveForm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="nx">form</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">$form</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">autosaveForm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">autosaveForm</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$form</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">autosaveForm</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">autosaveInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">autosaveForm</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">()</span>
</span><span class='line'>    <span class="p">},</span> <span class="mi">10000</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">AutosaveForm</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">saveForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">autosaveForm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">data</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;Post saved.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">autosaveForm</span><span class="p">.</span><span class="nx">formError</span><span class="p">()</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">saveFormIfChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">currentForm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">currentForm</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">savedForm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">saveForm</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$form</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">savedForm</span> <span class="o">=</span> <span class="nx">currentForm</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">formError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">autosaveInterval</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;unload&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">$form</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">form</span><span class="p">.</span><span class="nx">autosave</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutosaveForm</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">===</span> <span class="s2">&quot;save&quot;</span><span class="p">)</span> <span class="nx">form</span><span class="p">.</span><span class="nx">autosave</span><span class="p">.</span><span class="nx">saveFormIfChanged</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;form[data-autosave]&quot;</span><span class="p">).</span><span class="nx">autosave</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}(</span> <span class="nx">jQuery</span> <span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<h3>On your own</h3>

<p>Continue to improve this version. Here are a number of tasks to try on your own, but you can work on something you feel is missing:</p>

<ol>
<li>Rename the methods. <code>this.saveForm</code> is redundant, since <code>this</code> is a form. Change it to <code>this.save</code>. Change the names of the other methods to be more succinct.</li>
<li>Extract the concepts of &quot;form is different&quot; and &quot;save form state&quot; into their own methods. Add unit tests for these methods.</li>
<li>Change <code>formError</code> to <code>unbind</code>, and make a command so you can run <code>$(&quot;form&quot;).autosave(&quot;unbind&quot;)</code> and it removes the autosave bindings.</li>
<li>Add <a href="http://underscorejs.org">underscore.js</a> to the project and use <code>_.bind</code> and <code>_.bindAll</code> to simplify method scoping.</li>
</ol>

<h2>9. Exercises</h2>

<p>At this point we have all the tools that we need to implement more functionality on Scribblr, and keep it all covered with unit tests. Go back through the previous chapter&#8217;s extra sections and try implementing those suggestions.</p>

<p>Or, feel free to start working on new plugins. If you have a lot of time, try making a plugin that formats posts using asterisks for italics. Or try adding a <code>draft</code> column to the posts table, and save intermediate changes there. Then only publish the draft content when the user saves the form for real.</p>

<p>If you&#8217;re interested in coffeescript, convert some files to coffeescript. Rails can already handle coffeescript assets, so just change the extension to <code>.coffee</code> and Rails will compile it.</p>

    
    
      <footer>
        
        
          <div class="sharing">
  
  
</div>

        
      </footer>
    
  </article>


</div>


  <span class="toggle-sidebar"></span>

<aside class="sidebar">
  <div> </div>
</aside>

<script src="/javascripts/sidebar.js" type="text/javascript"> </script>


    </div>

    <div class="footer">
  <p>
    All materials licensed <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0</a>&nbsp;
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" />
  </p>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42709122-1', 'jumpstartlab.com');
ga('send', 'pageview');
</script>
  </div>

  


  <div class="slide-out-div">
  <a class="handle" href="#">Feedback</a>
  <h3>Have Feedback?</h3>
  <p>Did you find an error? Something confusing? We'd love your help:</p>
  <ul>
    <li><a href="#" id="edit_source">Edit the source code of this page directly on GitHub</a></li>
    <li><a href="https://github.com/JumpstartLab/curriculum/issues">Create a new issue on the project's GitHub page</a></li>
  </ul>
  <p>Thanks!</p>
</div>

<script>
  $(function(){
    var pathname = window.location.pathname.replace( ".html", ".markdown" );
    var github_url = "https://github.com/JumpstartLab/curriculum/blob/master/source" + pathname;
    $("a#edit_source").attr('href', github_url);
  });
</script>

</body>
</html>
