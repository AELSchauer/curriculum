
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sessions and Conversations - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="Controllers                                      Sessions and Conversations                              HTTP is a stateless &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tutorials.jumpstartlab.com/topics/controllers/sessions_and_conversations.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">

  <!-- TAB SLIDE OUT -->
  <script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tabSlideOut.v1.3.js"></script>

  <!-- SEARCH -->
  <script src="/search.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.slide-out-div').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        pathToTabImage: '/images/feedback_tabv2.png', //path to the image for the tab //Optionally can be set using css
        imageHeight: '130px',                     //height of tab image           //Optionally can be set using css
        imageWidth: '36px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 300,                               //speed of animation
        action: 'click',                          //options: 'click' or 'hover', action to trigger animation
        topPos: '200px',                          //position from the top/ use if tabLocation is left or right
        leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
        fixedPosition: true                      //options: true makes it stick(fixed position) on scroll
        });
      });
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner">
    <hgroup>
  <h1>Jumpstart Lab Curriculum</h1>
  
</hgroup>

  </header>

  <nav role="navigation">
    <ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tutorials.jumpstartlab.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
  <li><div id="search">
  <form>
    <input type="text" id="st-search-input" class="st-search-input" />
  </form>
</div>
</li>
</ul>
  </nav>

  <div id="main">
    <div id="content">
      <div>
  <article role="article">
    
      
        <p class="section-title">Controllers</p>
      
    
    
      <header>
        <h1 class="entry-title">
          Sessions and Conversations
        </h1>
        
      </header>
    
    <p>HTTP is a stateless protocol. Sessions allow us to chain multiple requests together into a conversation between client and server.</p>

<p>Sessions should be an option of last resort. If there&#8217;s nowhere else that the data can possibly go to achieve the desired functionality, only then should it be stored in the session. Sessions can be vulnerable to security threats from third parties, malicious users, and can cause scaling problems.</p>

<p>We should only use them where necessary.</p>

<h2>Adding, Accessing, and Removing Data</h2>

<p>Rails gives us access to the current session through the <code>session</code> helper method. Much like the <code>params</code> method, the <code>session</code> method returns us an object that we can think of as a hash. In reality it is an instance of <code>ActionDispatch::Session::AbstractStore::SessionHash</code>.</p>

<h3>Adding Data</h3>

<p>We can add information to the session just like a regular hash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="vi">@order</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">create</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:order</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@order</span><span class="o">.</span><span class="n">to_param</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The session can store any kind of string data, but you&#8217;re best served by keeping it as small as possible for both speed and security. Instead of storing whole objects, store the ID of an object and then do a lookup on the server side, as necessary.</p>

<h3>Reading Data</h3>

<p>In the current or later requests you can access that data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">add_to_cart</span>
</span><span class='line'>  <span class="vi">@order</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:order</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@order</span> <span class="o">&lt;&lt;</span> <span class="no">Product</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Note that we only fetch an order ID from the session, and then run a scoped query against the database. We rely on <code>current_user.orders</code> to scope the search to just orders attached to this user. </p>

<p>You should be skeptical of the data coming out of a session and assume that a user can, in one way or another, modify the data. Scoping queries like this can insulate you from serious security issues.</p>

<h3>Deleting Data</h3>

<p>Just like a hash, values can be cleared by setting them to <code>nil</code> or calling <code>delete</code> with the key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">session</span><span class="o">[</span><span class="ss">:order</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'><span class="c1"># or</span>
</span><span class='line'><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Reset</h3>

<p>If you want to erase the entire session, call <code>reset_session</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="n">reset_session</span>
</span><span class='line'>  <span class="vi">@order</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">create</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:order</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@order</span><span class="o">.</span><span class="n">to_param</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Storage Options</h2>

<p>Where you store the session data has implications for both performance and security.</p>

<h3>User Cookies</h3>

<p>The default storage mechanism is the browser&#8217;s cookie.</p>

<ul>
<li>Advantages

<ul>
<li>No server storage</li>
<li>No extra queries server-side</li>
<li>No setup effort</li>
</ul></li>
<li>Disadvantages

<ul>
<li>User access / visibility, possible tampering</li>
<li>4kb Size Limit</li>
<li>Sent with each request (increasing total bandwidth)</li>
</ul></li>
</ul>

<p>There is no configuration necessary to use cookie storage, they are set up and turned on by default.</p>

<h3>Database Storage with <code>ActiveRecordStore</code></h3>

<p>Some sites choose to use database storage to move the bulk of the data server-side:</p>

<ul>
<li>Advantages

<ul>
<li>Size limited only by database</li>
<li>Less prone to user tampering</li>
<li>Only uses a cookie to track session id</li>
<li>Less data transferred to/from client</li>
</ul></li>
<li>Disadvantages

<ul>
<li>Causes an extra database query on every request</li>
<li>Can inflate database disk/memory usage</li>
<li>Need to be pruned via monitor process</li>
</ul></li>
</ul>

<h4>Setup</h4>

<p>First, you will need to intall the &#8216;activerecord-session_store&#8217; gem to your Gemfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;activerecord-session_store&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then run &#8216;bundle&#8217; from your command prompt.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line output'>bundle</span></code></pre></td></tr></table></div></div>
        </div>

<p>Next, create a migration to build the database table. From your command prompt:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails generate active\_record:session_migration</span><span class='line output'></span><span class='line command'>rake db:migrate</span></code></pre></td></tr></table></div></div>
        </div>

<p>Then open <code>config/initializers/session_store.rb</code> and change the line like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="s1">&#39;_myapp_session&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>To this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span> <span class="ss">:active_record_store</span>
</span></code></pre></td></tr></table></div></figure>

<p>Restart the server if it is running. No other changes in the app are necessary.</p>

<h3>In-Memory Storage with Redis and <code>redis-store</code></h3>

<p>The best option for scalable server-side session storage is to use Redis (<a href="http://redis.io/">http://redis.io/</a>). Redis is an extremely fast in-memory data store which can be used for direct data storage, caching, and session storage. It is becoming an essential component of any major Rails application.</p>

<p>The <code>redis-store</code> library provides a Ruby interface to each of these jobs. Specifically, <code>Rack::Session::Redis</code> implements the session storage interface that Rails expects. </p>

<ul>
<li>Advantages

<ul>
<li>Size limited only by Redis</li>
<li>Little danger of user tampering</li>
<li>Only uses a cookie to track session id client side</li>
<li>Little data transferred to/from client</li>
<li>Extremely fast querying and storing of data<br></li>
</ul></li>
<li>Disadvantages

<ul>
<li>Necessitates extra process / setup</li>
<li>Need to be pruned via monitor process</li>
</ul></li>
</ul>

<h4>Setup</h4>

<p>Setup and start the Redis server. Add a dependency on the <code>redis-store</code> gem to your <code>Gemfile</code> and run <code>bundle</code>.</p>

<p>Open <code>config/initializers/session_store.rb</code> and change the line like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MyApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="s1">&#39;_myapp_session&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>To this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MyApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Redis</span>
</span></code></pre></td></tr></table></div></figure>

<p>Restart the server and you&#8217;re ready to go!</p>

<h2>Exercises</h2>

<div class="note">
  <p>Use the Blogger sample application to complete the exercises in this section. See the <a href="/topics/sample_project.html">Setup Instructions</a> for help.</p>
</div>

<ol>
<li>Output the entire session by calling <code>debug session.inspect</code> from the application layout.</li>
<li>Write a <code>before_filter</code> in <code>ApplicationController</code> named <code>set_last_action</code> and trigger it on every action in the application. In the action, store the current time into a session key named <code>last_action</code>. Look for the value in your debug output.</li>
<li>Write an <code>after_filter</code> in <code>ApplicationController</code>, triggered on every action, that <em>appends</em> the timestamp in <code>last_action</code> to the current <code>flash[:notice]</code>. Remove the <code>debug session.inspect</code> from your layout and observe the timestamp in the flash of each action.</li>
<li>Follow the steps in the text to implement database-backed sessions. Restart your server and verify the filters still work as expected. <em>CHALLENGE</em>: using a database inspection tool, look at the sessions table and find how the session is serialized. What data format is that? What security threat does this pose?</li>
</ol>

<h2>Reference</h2>

<ul>
<li>Rails Guide on Security (&amp; Sessions): <a href="http://guides.rubyonrails.org/security.html#sessions">http://guides.rubyonrails.org/security.html#sessions</a></li>
<li>Rails Guide on Configuring Rails Applications: <a href="http://guides.rubyonrails.org/configuring.html">http://guides.rubyonrails.org/configuring.html</a></li>
<li>Redis: <a href="http://redis.io/">http://redis.io/</a></li>
<li><code>redis-store</code>: <a href="https://github.com/jodosha/redis-store">https://github.com/jodosha/redis-store</a> and <a href="http://jodosha.github.com/redis-store/">http://jodosha.github.com/redis-store/</a></li>
</ul>

    
    
      <footer>
        
        
          <div class="sharing">
  
  
</div>

        
      </footer>
    
  </article>


</div>



    </div>

    <div class="footer">
  <p>
    All materials licensed <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0</a>&nbsp;
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" />
  </p>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42709122-1', 'jumpstartlab.com');
ga('send', 'pageview');
</script>
  </div>

  


  <div class="slide-out-div">
  <a class="handle" href="#">Feedback</a>
  <h3>Have Feedback?</h3>
  <p>Did you find an error? Something confusing? We'd love your help:</p>
  <ul>
    <li><a href="#" id="edit_source">Edit the source code of this page directly on GitHub</a></li>
    <li><a href="https://github.com/JumpstartLab/curriculum/issues">Create a new issue on the project's GitHub page</a></li>
  </ul>
  <p>Thanks!</p>
</div>

<script>
  $(function(){
    var pathname = window.location.pathname.replace( ".html", ".markdown" );
    var github_url = "https://github.com/JumpstartLab/curriculum/blob/master/source" + pathname;
    $("a#edit_source").attr('href', github_url);
  });
</script>

</body>
</html>
