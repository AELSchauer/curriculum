
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Intro to CSV - Level II - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="Intro to CSV - Level II                              We will use the csv-exercisesrepository to practice using test &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tutorials.jumpstartlab.com/academy/workshops/csv/ii.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">

  <!-- TAB SLIDE OUT -->
  <script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tabSlideOut.v1.3.js"></script>

  <!-- SEARCH -->
  <script src="/search.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.slide-out-div').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        pathToTabImage: '/images/feedback_tabv2.png', //path to the image for the tab //Optionally can be set using css
        imageHeight: '130px',                     //height of tab image           //Optionally can be set using css
        imageWidth: '36px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 300,                               //speed of animation
        action: 'click',                          //options: 'click' or 'hover', action to trigger animation
        topPos: '200px',                          //position from the top/ use if tabLocation is left or right
        leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
        fixedPosition: true                      //options: true makes it stick(fixed position) on scroll
        });
      });
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner">
    <hgroup>
  <h1>Jumpstart Lab Curriculum</h1>
  
</hgroup>

  </header>

  <nav role="navigation">
    <ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tutorials.jumpstartlab.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
  <li><div id="search">
  <form>
    <input type="text" id="st-search-input" class="st-search-input" />
  </form>
</div>
</li>
</ul>
  </nav>

  <div id="main">
    <div id="content">
      <div>
  <article role="article">
    
    
      <header>
        <h1 class="entry-title">
          Intro to CSV - Level II
        </h1>
        
      </header>
    
    <p>We will use the <a href="https://github.com/JumpstartLab/csv-exercises">csv-exercises</a>
repository to practice using test-driven development and working with objects.</p>

<p>This tutorial builds on concepts developed in
<a href="/academy/workshops/csv/i.html">Intro to CSV - Level I</a>.</p>

<p>There are five exercises, and this tutorial guides you through the process of
solving the first one.</p>

<h2>Getting Started</h2>

<p>If you do not have the repository on your local machine, start by cloning it:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git clone git@github.com:JumpstartLab/csv-exercises.git</span><span class='line command'>cd csv-exercises</span></code></pre></td></tr></table></div></div>
        </div>

<p>If you do have it, then you&#8217;re fine. Make sure that you&#8217;ve committed any
changes, so that your working directory is clean, and that you&#8217;re on the
master branch.</p>

<p>Fetch the latest changes from the upstream repository, and ensure that your
master matches it:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git fetch origin</span><span class='line command'>git reset --hard origin/master</span></code></pre></td></tr></table></div></div>
        </div>

<p>Then check out a new branch to work on the <code>level-ii</code> exercises:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout -b level-ii</span></code></pre></td></tr></table></div></div>
        </div>

<p>Go to the <code>level-ii</code> directory:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>cd level-ii</span></code></pre></td></tr></table></div></div>
        </div>

<p>We&#8217;ll be working on the Phone Book exercise, so change directories to
<code>phone_book</code>:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line output'>cd phone_book</span></code></pre></td></tr></table></div></div>
        </div>

<h2>Inspecting the Data</h2>

<p>For our electronic telephone directory listing service we want to be able to
look people up by their last name, or by their first and last name. Also, we
want to provide a reverse lookup, where we input a number, and get back the
name of the person who owns it, along with any contact information that we
have for them.</p>

<p>If you open up the <code>./data</code> directory you&#8217;ll see two files:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line output'>./data/</span><span class='line output'>├── people.csv</span><span class='line output'>└── phone_numbers.csv</span></code></pre></td></tr></table></div></div>
        </div>

<p>We have many people, each of whom are identified by a unique identifier in the
<code>people.csv</code> file. Each person can have multiple phone numbers. The phone
numbers are listed in the <code>phone_numbers.csv</code>, and are connected to the person
via the same unique identifier.</p>

<p>The phone book does not expose this unique identifier to the outside world,
it&#8217;s just an internal accounting system so that it can keep people straight,
and distinguish between all the various Bob Joneses (or whoever) that we have
in the system.</p>

<h2>Designing the Interface</h2>

<p>We have three ways of looking up data in our telephone directory listing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># By last name</span>
</span><span class='line'><span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># By first and last name</span>
</span><span class='line'><span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Smith, Alice&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># By number</span>
</span><span class='line'><span class="n">phone_book</span><span class="o">.</span><span class="n">reverse_lookup</span><span class="p">(</span><span class="s1">&#39;123-555-1234&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Since each person may have many numbers, the result of each search will be an
array of phone book entries, where each entry contains the person&#8217;s name, and
a list of all their phone numbers.</p>

<p>The reverse lookup could potentially result in multiple entries, since
people living together might share a number, and this number would be
registered to each person separately.</p>

<h2>Knowing When We&#8217;re Done</h2>

<p>We will develop a <em>minimum usable product</em> using an integration test, which
will be failing until we&#8217;ve achieved a working feature.</p>

<h3>A Quick Refresher on Errors vs Failures</h3>

<p>An <strong>error</strong> means that the code cannot even run. There&#8217;s a missing file, a
class hasn&#8217;t been defined, or we&#8217;re calling a method that does not exist.</p>

<p>A <strong>failure</strong> is a missed expectation. We wanted chocolate cake, but were
given oatmeal cookies with raisins. It&#8217;s not broken, it&#8217;s just a
disappointment.</p>

<p>We will use the integration test to fix errors. If the integration test blows
up because we don&#8217;t have a file, we&#8217;ll create the file.</p>

<p>However, once the integration test complains that it expected one thing, but
got something else, that will be our signal to drop to a lower level in the
application, abandon the integration test for a while, and develop the
necessary code using more fine-grained tests.</p>

<p>When the fine-grained tests are passing, then we will pop back up to the
integration test, work through any errors, and then use the next failure to
guide us towards the next tests we need to write.</p>

<h2>Writing a Failing Test</h2>

<p>Create an empty file called <code>test/integration_test.rb</code>. We&#8217;re going to start
by adding the usual testing boilerplate to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;minitest&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.2&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/phone_book&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">IntegrationTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re going to write a single test that pretends it is in production (no
fakes or mocks or fixtures). This test will prove that we can look people up
by last name.</p>

<p>If you open up the file and manually count the people with last name
<strong>Mueller</strong>, you should get 2 names: Justina Mueller and Sharon Mueller.</p>

<p>We don&#8217;t want to enforce any sort of ordering of the search results, so before
we make the assertions, we&#8217;ll sort what came back. Then we need to prove that
we got the right names and that the numbers are associated to the correct
person.</p>

<p>Here&#8217;s the test I came up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">IntegrationTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_lookup_by_last_name</span>
</span><span class='line'>    <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">entries</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Mueller&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">first_name</span><span class="p">}</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Justina Mueller&quot;</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Sharon Mueller&quot;</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(433) 346-3946&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(296) 580-0926&quot;</span><span class="p">,</span> <span class="s2">&quot;(484) 305-0295&quot;</span><span class="p">,</span> <span class="s2">&quot;(836) 069-1792&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Handling the First Errors</h2>

<p>There are a number of wiring issues, which are exposed by this test:</p>

<ul>
<li>We don&#8217;t have a file called <code>phone_book.rb</code></li>
<li>We don&#8217;t have a <code>PhoneBook</code> class</li>
<li>We don&#8217;t have a method <code>lookup</code> for the <code>PhoneBook</code> instance</li>
<li>The <code>lookup</code> method needs to return something that responds to <code>sort_by</code>,
such as an array</li>
</ul>

<p>Fixing all of these errors results in the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PhoneBook</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>At this point the test produces a failure rather than an error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Failure:
</span><span class='line'>IntegrationTest#test_lookup_by_last_name [test/integration_test.rb:10]:
</span><span class='line'>Expected: 2
</span><span class='line'>  Actual: 0</span></code></pre></td></tr></table></div></figure>

<h2>Driving a Feature with Lower-Level Tests</h2>

<p>We&#8217;re getting a failure because we expect to get 2 results back from the
lookup method, but we&#8217;re hard-coding an empty array.</p>

<p>We need a phone book that, given a bunch of entries, will find the right ones
for us. Let&#8217;s defer having to know about how entries are getting out of the
CSV files, and just talk to an <code>EntryRepository</code> who just handles that for us.</p>

<p>So let&#8217;s punt.</p>

<p>We&#8217;ll create a test that just says that phone book talks to the entry
repository correctly.</p>

<p>What does <em>correctly</em> mean? Well, we get to make that up.</p>

<p>The <code>lookup</code> method is going to have to either ask the repository to go fetch
people by last name, or by first and last name. Let&#8217;s have explicit methods
for each of those:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">repository</span><span class="o">.</span><span class="n">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'><span class="c1"># and</span>
</span><span class='line'><span class="n">repository</span><span class="o">.</span><span class="n">find_by_first_and_last_name</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>We could give the phone book a fake repository with fake data, and then assert
that what we get back when we call <code>lookup(name)</code> is whatever the fake
repository returns for <code>find_by_last_name</code>, but that seems kind of pointless.</p>

<p>Instead we&#8217;ll implement a mock assertion that the interaction is correct.</p>

<p>In the <code>test/phone_book_test.rb</code> add the following test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;minitest&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.2&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/mock&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/phone_book&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PhoneBookTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">repository</span>
</span><span class='line'>    <span class="vi">@repository</span> <span class="o">||=</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Mock</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_lookup_by_last_name</span>
</span><span class='line'>    <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="n">repository</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:find_by_last_name</span><span class="p">,</span> <span class="o">[]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;Smith&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">repository</span><span class="o">.</span><span class="n">verify</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We are making sure that it calls the method with the right arguments
(&quot;Smith&quot;), and we&#8217;re faking out the return value to be an empty array.</p>

<p>We get a couple of straight-forward errors:</p>

<ul>
<li><code>PhoneBook</code> needs an <code>initialize</code> that takes a repository.</li>
<li><code>lookup</code> needs to delegate to the <code>repository</code></li>
</ul>

<p>This gives us the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PhoneBook</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:repository</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@repository</span> <span class="o">=</span> <span class="n">repository</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">repository</span><span class="o">.</span><span class="n">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test is passing.</p>

<p>Now we need to go back to the integration test, fix any errors, and then let
the failure tell us where to go next.</p>

<h2>Where to Go Next</h2>

<p>Now our integration test is giving errors again rather than failures.</p>

<p>The first error is complaining about how we create a new <code>PhoneBook</code> instance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Error:
</span><span class='line'>IntegrationTest#test_lookup_by_last_name:
</span><span class='line'>ArgumentError: wrong number of arguments (0 for 1)
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/phone_book.rb:4:in `initialize'</span></code></pre></td></tr></table></div></figure>

<p>The test is calling <code>PhoneBook.new</code>, but now phone book&#8217;s <code>initialize</code> expects an argument.</p>

<p>We don&#8217;t want to have to tell the phone book where to find its data, so let&#8217;s
provide a default repository that it can use if nothing is passed in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PhoneBook</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:repository</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repository</span><span class="o">=</span><span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s1">&#39;./data&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="vi">@repository</span> <span class="o">=</span> <span class="n">repository</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This blows up, naturally, since we just pulled the <code>EntryRepository</code> out of
thin air.</p>

<p>Follow the trail of no such files, constants, and methods, until the
integration test is producing an assertion failure rather than errors.</p>

<p>Remember that in the integration test you should have a single <code>require</code>
statement that has anything to do with the application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;./lib/phone_book&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>If the app needs to load files to get the integration test to pass, put those
require statements inside the <code>lib/phone_book.rb</code> file.</p>

<p>All tests for anything other than the <code>lib/phone_book</code> class should put
require statements in the test file.</p>

<p>You&#8217;ll have something to this effect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">EntryRepository</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">in</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The failing integration is back to the usual:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Failure:
</span><span class='line'>IntegrationTest#test_lookup_by_last_name [test/integration_test.rb:10]:
</span><span class='line'>Expected: 2
</span><span class='line'>  Actual: 0</span></code></pre></td></tr></table></div></figure>

<p>Run the <code>test/phone_book_test.rb</code> to make sure we haven&#8217;t broken anything
while wiring up the integration test. It should still be passing.</p>

<h2>Moving On</h2>

<p>The failure that we&#8217;re getting is telling us that we&#8217;re not getting any
real results from <code>find_by_last_name</code> in the <code>EntryRepository</code>. This makes
sense, since we&#8217;re hard-coding an empty array.</p>

<p>We know that <code>EntryRepository</code> needs to handle two different CSV files, and we
can assume that it will handle both of them very similarly. Let&#8217;s put off
having to actually read CSV files for a while, and just assume that the entry
repository is given two sets of data: one for people and one for phone
numbers.</p>

<p>We&#8217;re going to need to look up multiple entries by last name, so our fake data
should have two matches and one non-match to ensure that we correctly
<strong>include</strong> people with the right last name and correctly <strong>exclude</strong> people
with a different last name.</p>

<p>Also, since people can have more than one number, we should make sure that one
of the fake entries has more than one phone number, to make sure that we don&#8217;t
just return the first number for each person.</p>

<p>Building on what we learned working through CSV-I, we&#8217;ll make it so that
<code>EntryRepository</code> returns objects. Since the data is spread out across two
files, we&#8217;ll want an object that represents the combined records for a single
person. Let&#8217;s call it <code>Entry</code>.</p>

<p>Here&#8217;s a simple test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">EntryRepositoryTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">people</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>      <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Jones&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">phone_numbers</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>      <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111.111.1111&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111.111.2222&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;222-222-1111&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">repository</span>
</span><span class='line'>    <span class="vi">@repository</span> <span class="o">||=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">phone_numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_find_by_last_name</span>
</span><span class='line'>    <span class="n">entries</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_last_name</span><span class="p">(</span><span class="s2">&quot;Smith&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">first_name</span><span class="p">}</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">alice</span><span class="p">,</span> <span class="n">bob</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Alice Smith&quot;</span><span class="p">,</span> <span class="n">alice</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;111.111.1111&quot;</span><span class="p">,</span> <span class="s2">&quot;111.111.2222&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">alice</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Bob Smith&quot;</span><span class="p">,</span> <span class="n">bob</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;222-222-1111&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">bob</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is basically the same test as the integration test, except that we&#8217;re not
actually integrating with real data. Provided that the repository has data, we
should be able to get a subset of that data.</p>

<p>There are a number of good reasons why our test is blowing up. The first is
that we need to give the <code>EntryRepository</code> an <code>initialize</code> method that takes
the data hashes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">EntryRepository</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">in</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">phone_numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Next, we need an <code>Entry</code> object.</p>

<p>We&#8217;ll use a simple struct for now, and we won&#8217;t bother testing it directly.
Perhaps later, if it attracts more behavior, we will make it a more
sophisticated class and give it its own tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/entry.rb</span>
</span><span class='line'><span class="no">Entry</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:numbers</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>It also needs to have a <code>:name</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Entry</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:numbers</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">name</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>OK. Where were we?</p>

<p>The <code>EntryRepository#find_by_last_name</code> is returning a hard-coded empty array,
but our test is expecting two entries.</p>

<p>We need to find the right people to return:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">EntryRepository</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">in</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:people</span><span class="p">,</span> <span class="ss">:phone_numbers</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">phone_numbers</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@people</span> <span class="o">=</span> <span class="n">people</span>
</span><span class='line'>    <span class="vi">@phone_numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">people</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>      <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span> <span class="o">==</span> <span class="nb">name</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This, of course, returns a hash, not an Entry, so we need to plug the data
into the object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span> <span class="o">==</span> <span class="nb">name</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">data</span><span class="o">|</span>
</span><span class='line'>    <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This gets us past the first assertion, since we have the right name, but now
we need to associate the correct phone numbers with this data.</p>

<p>Here&#8217;s what I came up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span> <span class="o">==</span> <span class="nb">name</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span><span class="o">[</span><span class="ss">:person_id</span><span class="o">]</span> <span class="o">==</span> <span class="n">person</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span><span class="o">[</span><span class="ss">:phone_number</span><span class="o">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>That passes the test, but this is getting pretty hairy. Let&#8217;s step back and
think about this for a bit.</p>

<h2>Programming by Wishful Thinking</h2>

<p>Here&#8217;s the code I wish I could write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>  <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This would mean that <code>people</code> and <code>phone_numbers</code> are not arrays, but actual
objects. Maybe each CSV file could be read into a small database object that
can provide a nice search interface like <code>find_by</code>.</p>

<h2>Test-Driving a CSV Wrapper</h2>

<p>We&#8217;ll write some tests to drive out the design of a simple object that reads
data from a CSV file and provides a search interface to those objects.</p>

<p>Once we have that working, we can refactor the <code>EntryRepository</code> to use it.</p>

<p>First, we&#8217;re going to need a small fixture file. We could use something that
looks like our people or phone number CSV file, but really it shouldn&#8217;t matter
what fields are in the file &#8211; the wrapper should handle any existing fields
seamlessly.</p>

<p>The customary location for support files like this is a directory within
<code>test</code> called <code>fixtures</code>.</p>

<p>Create an empty file <code>test/fixtures/things.csv</code>:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>touch test/fixtures/things.csv</span></code></pre></td></tr></table></div></div>
        </div>

<p>We want at least two fields. Keeping it simple, let&#8217;s go with <code>id</code> and <code>name</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csv'><span class='line'>id,name
</span><span class='line'>1,popsicle
</span><span class='line'>2,tire
</span><span class='line'>3,tire</span></code></pre></td></tr></table></div></figure>

<h3>Writing a Failing Test</h3>

<p>We want to tell the database where to find the CSV file, but it would also be
very handy to be able to create a database just by giving it arrays of hashes
representing the CSV data.</p>

<p>It&#8217;s considered good form to do as little work as possible within the
<code>initialize</code> method, so we&#8217;ll use <code>initialize</code> to assign rows of data.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">db</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then we&#8217;ll add an extra class method that will read from the file system:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">db</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;path/to/file.csv&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;minitest&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.2&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/db&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DBTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">filename</span>
</span><span class='line'>    <span class="vi">@filename</span> <span class="o">||=</span> <span class="no">File</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">(</span><span class="s2">&quot;../fixtures/things.csv&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">db</span>
</span><span class='line'>    <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_find_by_name</span>
</span><span class='line'>    <span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;tire&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">things</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">things</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">thing</span><span class="o">|</span> <span class="n">thing</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Running the test gives us all the usual complaints.</p>

<p>Follow the trail:</p>

<ul>
<li>create an empty file</li>
<li>add empty class DB</li>
<li>add a class method <code>read</code></li>
<li>&#8230; that takes a paramater <code>filename</code></li>
<li>return <code>new</code> from the <code>read</code> method</li>
<li>add an instance method called <code>find_by</code> method</li>
<li>&#8230; that takes a <code>field</code> and a <code>value</code></li>
<li>return an empty array from the <code>find_by</code> method</li>
</ul>

<p>That should give you the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DB</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_by</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We now have a real failure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Failure:
</span><span class='line'>DBTest#test_find_by_name [db_test.rb:14]:
</span><span class='line'>Expected: 2
</span><span class='line'>  Actual: 0</span></code></pre></td></tr></table></div></figure>

<p>We need to return actual data from the <code>find_by</code> method.</p>

<p>Let&#8217;s read the CSV file, and convert the rows to an array, passing it to <code>new</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="kp">new</span> <span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">header_converters</span><span class="p">:</span> <span class="ss">:symbol</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the test, which will fail because it doesn&#8217;t know about a <code>CSV</code> class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NameError: uninitialized constant DB::CSV</span></code></pre></td></tr></table></div></figure>

<p>The CSV library ships with Ruby, but it is in the Standard Library, not in
Core, so we have to explicitly say that we want to use it.</p>

<p>Require &#8216;csv&#8217; from the standard library in the test file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the test again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ArgumentError: wrong number of arguments(1 for 0)
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/db.rb:3:in `initialize'</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re passing an argument to <code>initialize</code>, but the default initialize method
doesn&#8217;t accept any arguments.</p>

<p>Add the initialize method, and expose the incoming rows using an
<code>attr_reader</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DB</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span> <span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">header_converters</span><span class="p">:</span> <span class="ss">:symbol</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:data</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@data</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_by</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test is failing, but we finally have what we need to make it pass. Loop
through the rows to find the ones you need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">datum</span><span class="o">|</span> <span class="n">datum</span><span class="o">[</span><span class="n">field</span><span class="o">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This gets the test passing.</p>

<h3>Modifying <code>EntryRepository</code> to use the DB</h3>

<p>Inside the <code>entry_repository_test</code> we have a method <code>people</code> that returns the
hashes representing CSV rows. We need to provide a <code>DB</code> object that is holding
onto the rows rather than the rows themselves.</p>

<p>Rename that method to <code>people_data</code>, and create a new method <code>people</code> that
returns a database using those rows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">EntryRepositoryTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">people_data</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>      <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Jones&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">people</span>
</span><span class='line'>    <span class="no">DB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">people_data</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Do the same for the <code>phone_numbers</code>.</p>

<p>The tests blow up, because they don&#8217;t know about the <code>DB</code> constant.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NameError: uninitialized constant EntryRepositoryTest::DB</span></code></pre></td></tr></table></div></figure>

<p>Require the <code>db</code> file from within the test suite, and run the test again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1) Error:
</span><span class='line'>  EntryRepositoryTest#test_find_by_last_name:
</span><span class='line'>  NoMethodError: private method `select' called for #&lt;DB:0x007fc572a37250&gt;</span></code></pre></td></tr></table></div></figure>

<p>This error is fairly cryptic. It says that we&#8217;re calling <code>select</code> on the <code>DB</code>
instance. We never created a method named <code>select</code> on <code>DB</code>, but apparently
there&#8217;s a method named <code>select</code> that <code>DB</code> inherited from someone &#8211; probably
<code>Object</code>.</p>

<p>We&#8217;re calling <code>select</code> in order to filter the rows, but what we really want to
do is use the new <code>find_by</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span><span class="o">[</span><span class="ss">:phone_number</span><span class="o">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This gets the <code>entry_repository_test.rb</code> passing. In fact, at the moment,
<code>db_test.rb</code>, <code>entry_repository_test.rb</code> and <code>phone_book_test.rb</code> are all
passing, so we need to go back to the integration test to figure out what our
next step is.</p>

<h2>What&#8217;s Next?</h2>

<p>The integration test is not happy. It&#8217;s throwing an <code>ArgumentError</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Error:
</span><span class='line'>IntegrationTest#test_lookup_by_last_name:
</span><span class='line'>ArgumentError: wrong number of arguments (0 for 1)
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/entry_repository.rb:10:in `initialize'
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/entry_repository.rb:5:in `new'
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/entry_repository.rb:5:in `in'
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/phone_book.rb:6:in `initialize'
</span><span class='line'>    test/integration_test.rb:8:in `new'
</span><span class='line'>    test/integration_test.rb:8:in `phone_book'
</span><span class='line'>    test/integration_test.rb:12:in `test_lookup_by_last_name'</span></code></pre></td></tr></table></div></figure>

<p>Somewhere in this mess, we&#8217;re calling the <code>EntryRepository.new</code> wrong. Tracing
through the stacktrace suggests that it all starts when we call
<code>PhoneBook.new</code> without any parameters. This uses the default value for the
repository, which is <code>EntryRepository.in('./data')</code>.</p>

<p>The <code>in</code> method looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">in</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="kp">new</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>So we&#8217;re basically calling <code>EntryRepository.new</code> without any parameters, but
we changed <code>EntryRepository#initialize</code> to take an options hash that provides
the two CSV database wrapper objects: <code>people</code> and <code>phone_numbers</code>.</p>

<p>We need to create those two database objects and pass them to the new
instance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">in</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;people.csv&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="n">phone_numbers</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;phone_numbers.csv&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="kp">new</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">phone_numbers</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We have wiring problems.</p>

<ul>
<li>Require &#8216;./lib/db&#8217; at the top of <code>./lib/phone_book.rb</code></li>
<li>Require &#8216;csv&#8217; at the top of <code>./lib/phone_book.rb</code></li>
<li>Require &#8216;./lib/entry&#8217; at the top of <code>./lib/phone_book.rb</code></li>
</ul>

<p>If we&#8217;ve done everything right, this should just work. It&#8217;s not.
We&#8217;re getting a failure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Failure:
</span><span class='line'>IntegrationTest#test_lookup_by_last_name [test/integration_test.rb:17]:
</span><span class='line'>Expected: ["(433) 346-3946"]
</span><span class='line'>  Actual: ["433-346-3946"]</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re very close, but we forgot about formatting the phone numbers.</p>

<p>The bit where we are getting phone numbers is within the <code>find_by_last_name</code>
method, and the relevant lines of code look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>  <span class="n">number</span><span class="o">[</span><span class="ss">:phone_number</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re returning whatever was stored in the CSV file, but phone numbers in the
file are formatted in a couple different ways. We need to normalize it.</p>

<p>Open up the test suite for <code>EntryRepository</code>. We&#8217;ve got assertions that expect
the unformated phone numbers. Tweak the assertions to expect the correct
format, and rerun the test.</p>

<p>This gives us a failure that we can work with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Failure:
</span><span class='line'>EntryRepositoryTest#test_find_by_last_name [test/entry_repository_test.rb:42]:
</span><span class='line'>--- expected
</span><span class='line'>+++ actual
</span><span class='line'>@@ -1 +1 @@
</span><span class='line'>-["(111) 111-1111", "(111) 111-2222"]
</span><span class='line'>+["111.111.1111", "111.111.2222"]</span></code></pre></td></tr></table></div></figure>

<p>The simplest thing we can do to make this pass is to format the number before
we return it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span> <span class="n">number</span><span class="o">[</span><span class="ss">:phone_number</span><span class="o">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span><span class="p">,</span> <span class="n">person</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We don&#8217;t have a format method, so we need to add it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</span><span class='line'>  <span class="n">digits</span> <span class="o">=</span> <span class="n">number</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;-.&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">area_code</span> <span class="o">=</span> <span class="n">digits</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>  <span class="n">exchange</span> <span class="o">=</span> <span class="n">digits</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="o">]</span>
</span><span class='line'>  <span class="n">subscriber</span> <span class="o">=</span> <span class="n">digits</span><span class="o">[-</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="s2">&quot;(%s) %s-%s&quot;</span> <span class="o">%</span> <span class="o">[</span><span class="n">area_code</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">subscriber</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This gets the entry repository test passing.</p>

<p>Pop back up and run the integration test.</p>

<p>It&#8217;s passing as well!</p>

<h2>Red, Green&#8230; Refactor</h2>

<p>The entry repository is getting pretty gross. <code>format</code> has nothing to do with
dealing with persistence of phone book entries.</p>

<p>Let&#8217;s refactor so that we have a <code>Person</code> class and a <code>PhoneNumber</code> class.
This will allow us to move all the formatting into <code>PhoneNumber</code>.</p>

<h3>Updating the DB to use the little objects</h3>

<p>Now we have little phone number and person objects, we need the
database to actually return these objects instead of csv rows/hashes.</p>

<p>Start by changing the test to match the new expectations. First, add a
<code>Thing</code> class in the <code>DBTest</code>.</p>

<p>We can use the <code>Thing</code> to wrap the rows of thing data.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DBTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Thing</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@id</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Tweak the assertions to send messages to the object instead of referencing
hash keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_find_by_name</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">things</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Well! That breaks everything.</p>

<p><code>DB.read</code> is still passing rows of CSV data, and we need to send objects, not
data to the <code>initialize</code> method.</p>

<p>Start by telling <code>read</code> what sort of object it should wrap each row in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DBTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">db</span>
</span><span class='line'>    <span class="vi">@db</span> <span class="o">||=</span> <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="no">Thing</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This requires three changes in the <code>db</code> file.</p>

<p>First, the <code>read</code> method needs to take a second parameter. I&#8217;m calling it
<code>klass</code>.</p>

<p>Next, the <code>read</code> method needs to loop through the csv data to create the
objects:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rows</span> <span class="o">=</span> <span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">header_converters</span><span class="p">:</span> <span class="ss">:symbol</span><span class="p">)</span>
</span><span class='line'>  <span class="n">objects</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>    <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kp">new</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>And then we need to send a message in <code>find_by</code> rather than referencing the
hash key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">datum</span><span class="o">|</span> <span class="n">datum</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The name <code>data</code> is no longer correct. Let&#8217;s use <code>objects</code>. I also don&#8217;t like
<code>field</code> for an object, so I&#8217;m swapping it out with <code>attribute</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DB</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
</span><span class='line'>    <span class="n">rows</span> <span class="o">=</span> <span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">header_converters</span><span class="p">:</span> <span class="ss">:symbol</span><span class="p">)</span>
</span><span class='line'>    <span class="n">objects</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>      <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kp">new</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:objects</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@objects</span> <span class="o">=</span> <span class="n">objects</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_by</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="n">objects</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="n">object</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re done with the <code>DB</code>, let&#8217;s pop back to the <code>entry_repository_test</code> and
see how bad the carnage is.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NoMethodError: undefined method `last_name' for {:id=&gt;"1", :first_name=&gt;"Alice", :last_name=&gt;"Smith"}:Hash</span></code></pre></td></tr></table></div></figure>

<p>That makes sense. We need to make objects.</p>

<h3>Creating Little Objects</h3>

<p>Let&#8217;s start with Person.</p>

<p>Create a new file, <code>test/person_test.rb</code>, and add the usual boilerplate:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;minitest&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.2&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./lib/person&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PersonTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Write a test that proves that the hash data gets wrapped in a method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_attributes</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>To get the test to pass we need a very simple Person class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:first_name</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@first_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Expand the test to include a last name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_attributes</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;Smith&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make it pass.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:first_name</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@first_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@last_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally, let&#8217;s add an assertion for the <code>id</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_attributes</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;Smith&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make the test pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:first_name</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@id</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@last_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:last_name</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@first_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:first_name</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;ve got a working <code>Person</code>, let&#8217;s create a <code>PhoneNumber</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;minitest&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.2&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./lib/phone_number&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PhoneNumberTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_person_id</span>
</span><span class='line'>    <span class="n">number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">number</span><span class="o">.</span><span class="n">person_id</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make the test pass, then add another test for formatting the number:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_format</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;(123) 456-7890&quot;</span><span class="p">,</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">phone_number</span><span class="p">:</span> <span class="s1">&#39;123-456-7890&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;(123) 456-7890&quot;</span><span class="p">,</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">phone_number</span><span class="p">:</span> <span class="s1">&#39;123.456.7890&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make the assertions pass, by borrowing the code from the
<code>EntryRepository#format</code> method.</p>

<p>The final code looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PhoneNumber</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:person_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@person_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:person_id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@input</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="ss">:phone_number</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>    <span class="s2">&quot;(%s) %s-%s&quot;</span> <span class="o">%</span> <span class="o">[</span><span class="n">area_code</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">subscriber</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">digits</span>
</span><span class='line'>    <span class="vi">@input</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;.-&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">area_code</span>
</span><span class='line'>    <span class="n">digits</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exchange</span>
</span><span class='line'>    <span class="n">digits</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">subscriber</span>
</span><span class='line'>    <span class="n">digits</span><span class="o">[-</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Once both the <code>Person</code> and <code>PhoneNumber</code> tests are passing, we can pop back
over to the test for the <code>EntryRepository</code>. We need to require the <code>person</code>
and <code>phone_number</code> files.</p>

<p>Then change the <code>people_data</code> so that it creates objects:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">people_data</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Jones&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">row</span><span class="p">)}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Fix <code>phone_number_data</code> similarly.</p>

<p>Finally tweak the <code>entry_repository</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test is passing. Go ahead and delete the <code>format</code> method.</p>

<p>Next, pop back up to the <code>test/phone_book_test.rb</code>. It still passes.</p>

<p>Now try the <code>test/integration_test.rb</code> again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Error:
</span><span class='line'>IntegrationTest#test_lookup_by_last_name:
</span><span class='line'>ArgumentError: wrong number of arguments (1 for 2)
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/db.rb:4:in `read'
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/entry_repository.rb:6:in `in'
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/phone_book.rb:6:in `initialize'
</span><span class='line'>    test/integration_test.rb:8:in `new'
</span><span class='line'>    test/integration_test.rb:8:in `phone_book'
</span><span class='line'>    test/integration_test.rb:12:in `test_lookup_by_last_name'</span></code></pre></td></tr></table></div></figure>

<p>We haven&#8217;t fixed the <code>DB.read</code> methods in <code>EntryRepository.in</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">in</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;people.csv&#39;</span><span class="p">),</span> <span class="no">Person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_numbers</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;phone_numbers.csv&#39;</span><span class="p">),</span> <span class="no">PhoneNumber</span><span class="p">)</span>
</span><span class='line'>  <span class="kp">new</span><span class="p">(</span><span class="n">people</span><span class="p">:</span> <span class="n">people</span><span class="p">,</span> <span class="n">phone_numbers</span><span class="p">:</span> <span class="n">phone_numbers</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then we&#8217;re missing some constants. Add all the necessary requires to
<code>lib/phone_book.rb</code>, and the integration test should finally pass.</p>

<h2>Running the entire test suite</h2>

<p>It&#8217;s getting a bit tedious to run each of the test files to make sure that a
change in one place doesn&#8217;t affect any of the other parts of the code. We can
create a rake task to run all the tests at once.</p>

<p>Create a <code>Rakefile</code>, with the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rake/testtask&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rake</span><span class="o">::</span><span class="no">TestTask</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;test/**/*_test.rb&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="n">default</span><span class="p">:</span> <span class="ss">:test</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now you can say <code>rake</code> to run all the tests in the entire project all at once.</p>

<h2>Speeding up integration test</h2>

<p>Run the entire test suite, and take note of the time that it takes to
complete.</p>

<p>On my laptop, it&#8217;s about a 10th of a second. That&#8217;s incredibly slow. Most of
the time is spent running the integration test, because it loads the entire
production database&#8230; and we haven&#8217;t even added the two other features yet!</p>

<p>Let&#8217;s create a minimal CSV fixture file to stand in for each of the production
files.</p>

<p>For the <code>test/fixtures/people.csv</code> file, we need at least two people with the
same last name, and one person with a different last name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csv'><span class='line'>id,last_name,first_name
</span><span class='line'>1,Smith,Alice
</span><span class='line'>2,Smith,Bob
</span><span class='line'>3,Jones,Charlie</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;ll give one of the people two phone numbers to make sure that we&#8217;re loading
all the data correctly. The other user only needs 1 number.</p>

<p>Add this to the <code>test/fixtures/phone_numbers.csv</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csv'><span class='line'>person_id,phone_number
</span><span class='line'>1,111-000-1234
</span><span class='line'>2,222.000.1234
</span><span class='line'>2,222.001.1234</span></code></pre></td></tr></table></div></figure>

<p>Give the <code>PhoneBook</code> a repository in the <code>test/fixtures/</code> directory and update
the assertions in the test to match the new expections.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;minitest&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.2&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/phone_book&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">IntegrationTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_lookup_by_last_name</span>
</span><span class='line'>    <span class="n">repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s1">&#39;./test/fixtures&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="n">entries</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">first_name</span><span class="p">}</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Alice Smith&quot;</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Bob Smith&quot;</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(222) 000-1234&quot;</span><span class="p">,</span> <span class="s2">&quot;(222) 001-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>That should cut the time it takes for the test suite to run from about 100 ms
to about 5 ms, which is <strong>much</strong> more reasonable.</p>

<p>We&#8217;ve completed an entire feature, which put most of the code we need in
place. The next feature will be a lot easier to add.</p>

<h2>Looking Up By First and Last Name</h2>

<p>For this feature we need to add some data to the test fixture. We need two
people with the same first and last name, as well as someone with the same
last name but different first name, so that we make sure that this person
doesn&#8217;t get included. Because we are using the Smiths to test the last name,
we&#8217;ll use the Joneses to test this new feature.</p>

<p>Update the fixture to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csv'><span class='line'>id,last_name,first_name
</span><span class='line'>1,Smith,Alice
</span><span class='line'>2,Smith,Bob
</span><span class='line'>3,Jones,Charlie
</span><span class='line'>4,Jones,Charlie
</span><span class='line'>5,Jones,David</span></code></pre></td></tr></table></div></figure>

<p>The jonses will need phone numbers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csv'><span class='line'>person_id,phone_number
</span><span class='line'>1,111-000-1234
</span><span class='line'>2,222.000.1234
</span><span class='line'>2,222.001.1234
</span><span class='line'>3,333-000-1234
</span><span class='line'>3,333.001.1234
</span><span class='line'>4,444.000.1234
</span><span class='line'>5,555-000-1234</span></code></pre></td></tr></table></div></figure>

<p>The test looks a lot like the previous one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_lookup_by_last_and_first_name</span>
</span><span class='line'>  <span class="n">repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s1">&#39;./test/fixtures&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="n">entries</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Jones, Charlie&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>  <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s1">&#39;(444) 444-1111&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s1">&#39;(333) 333-1111&#39;</span><span class="p">,</span> <span class="s1">&#39;(333) 333-2222&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>To make the test pass you will need to drop down to the <code>phone_book_test.rb</code>
and make a test that mocks out the interaction between <code>PhoneBook</code> and the
repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_lookup_by_first_and_last_name</span>
</span><span class='line'>  <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repository</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:find_by_first_and_last_name</span><span class="p">,</span> <span class="o">[]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;Smith&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Smith, Alice&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repository</span><span class="o">.</span><span class="n">verify</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Again, we&#8217;re using a mock. This time we call the same method (<code>lookup</code>), but
we expect to delegate to a different method on the <code>EntryRepository</code> instance,
and we expect it to receive two arguments (&quot;Alice&quot;, and &quot;Smith&quot;) rather than
just one, like in the previous test.</p>

<p>In order to get the test to pass, split the name on the comma, and then call
the correct method on the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">last</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">first</span>
</span><span class='line'>    <span class="n">repository</span><span class="o">.</span><span class="n">find_by_first_and_last_name</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">repository</span><span class="o">.</span><span class="n">find_by_last_name</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>PhoneBook</code> test is passing. Now go back to the integration test and see
if the feature is complete.</p>

<p>It&#8217;s not.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  1) Error:
</span><span class='line'>IntegrationTest#test_lookup_by_last_and_first_name:
</span><span class='line'>NoMethodError: undefined method `find_by_first_and_last_name' for #&lt;EntryRepository:0x007fc0f0b74798&gt;
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/lib/phone_book.rb:17:in `lookup'
</span><span class='line'>    /Users/you/csv-exercises/level-ii/phone_book/test/integration_test.rb:22:in `test_lookup_by_last_and_first_name'</span></code></pre></td></tr></table></div></figure>

<p>We still need to add the correct functionality to the <code>EntryRepository</code>.</p>

<p>Add more fake data to the entry repository test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">people_data</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Jones&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Jones&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;David&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Jones&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">row</span><span class="p">)}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">phone_numbers_data</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111.111.1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111.111.2222&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;222-222-1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;333-333-1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;333-333-2222&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;444-444-1111&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">row</span><span class="p">)}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Add a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_find_by_first_and_last_name</span>
</span><span class='line'>  <span class="n">entries</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_first_and_last_name</span><span class="p">(</span><span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="s2">&quot;Jones&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">length</span><span class="p">}</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>  <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(444) 444-1111&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(333) 333-1111&quot;</span><span class="p">,</span> <span class="s2">&quot;(333) 333-2222&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>And make it pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_first_and_last_name</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Once the <code>entry_repository_test.rb</code> is passing, run the entire test suite
again.</p>

<p>The integration test should also be passing. We have a bit of duplication in the integration test. Before moving on, let&#8217;s extract <code>repository</code> and <code>phone_book</code> into a setup method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">IntegrationTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:repository</span><span class="p">,</span> <span class="ss">:phone_book</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s1">&#39;./test/fixtures&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_lookup_by_last_name</span>
</span><span class='line'>    <span class="n">entries</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">first_name</span><span class="p">}</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Alice Smith&quot;</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Bob Smith&quot;</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(222) 000-1234&quot;</span><span class="p">,</span> <span class="s2">&quot;(222) 001-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_lookup_by_last_and_first_name</span>
</span><span class='line'>    <span class="n">entries</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Jones, Charlie&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">length</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s1">&#39;(444) 000-1234&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s1">&#39;(333) 000-1234&#39;</span><span class="p">,</span> <span class="s1">&#39;(333) 001-1234&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Adding Reverse Lookup</h2>

<p>The final feature is doing a reverse lookup.</p>

<p>As before we&#8217;ll start with an integration test, and then use failures there to
guide our way down through the application.</p>

<p>We can test the number against the fixture data that we have, but we&#8217;ll add a
twist: Let&#8217;s give David Jones one of Charlie Jones&#8217; numbers, as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>person_id,phone_number
</span><span class='line'>1,111-000-1234
</span><span class='line'>2,222.000.1234
</span><span class='line'>2,222.001.1234
</span><span class='line'>3,333-000-1234
</span><span class='line'>3,333.001.1234
</span><span class='line'>4,444.000.1234
</span><span class='line'>5,555-000-1234
</span><span class='line'>5,333.001.1234</span></code></pre></td></tr></table></div></figure>

<p>Then write the integration test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_reverse_lookup</span>
</span><span class='line'>  <span class="n">entries</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">reverse_lookup</span><span class="p">(</span><span class="s1">&#39;(333) 001-1234&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>  <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Charlie Jones&quot;</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(333) 000-1234&quot;</span><span class="p">,</span> <span class="s2">&quot;(333) 001-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;David Jones&quot;</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(333) 001-1234&quot;</span><span class="p">,</span> <span class="s2">&quot;(555) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Drop down to the phone book test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_reverse_lookup</span>
</span><span class='line'>  <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repository</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:find_by_number</span><span class="p">,</span> <span class="o">[]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;(123) 123-1234&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_book</span><span class="o">.</span><span class="n">reverse_lookup</span><span class="p">(</span><span class="s1">&#39;(123) 123-1234&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repository</span><span class="o">.</span><span class="n">verify</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make it pass by delegating to the repository.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">reverse_lookup</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repository</span><span class="o">.</span><span class="n">find_by_number</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the integration test, which tells us that we need to drop down to the entry repository.</p>

<p>This time, let&#8217;s add Alice&#8217;s first number to David&#8217;s account in the test data in <code>test/entry_repository_test.rb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">phone_numbers_data</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111.111.1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111.111.2222&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;222-222-1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;333-333-1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;333-333-2222&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;444-444-1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;111-111-1111&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">person_id</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">:</span> <span class="s2">&quot;555-555-1111&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">row</span><span class="p">)}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_reverse_lookup</span>
</span><span class='line'>  <span class="n">entries</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_number</span><span class="p">(</span><span class="s2">&quot;(111) 111-1111&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">first_name</span><span class="p">}</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>  <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">entries</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Alice Smith&quot;</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 111-1111&quot;</span><span class="p">,</span> <span class="s2">&quot;(111) 111-2222&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e1</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;David Jones&quot;</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 111-1111&quot;</span><span class="p">,</span> <span class="s2">&quot;(555) 555-1111&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">e2</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Get the test passing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_number</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>    <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="n">number</span><span class="o">.</span><span class="n">person_id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>      <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
</span><span class='line'>      <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the entire test suite, and everything passes.</p>

<h2>Refactor the Entry Repository</h2>

<p>The entry repository gets the job done, but it has a fair amount of
duplication.</p>

<p>These two lines occur in every method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
</span><span class='line'><span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>We can extract that into a method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">entry_for</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">numbers</span> <span class="o">=</span> <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:person_id</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now this method replace the duplicated code in each of the finders:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_by_last_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">entry_for</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">find_by_first_and_last_name</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">entry_for</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">find_by_number</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_numbers</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>    <span class="n">people</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="n">number</span><span class="o">.</span><span class="n">person_id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>      <span class="n">entry_for</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Done!</h2>

<p>That&#8217;s it. We have a fully functional directory listing.</p>

<h2>Practice More</h2>

<p>You&#8217;re on your own for these.</p>

<h3>Calendar</h3>

<p>People have a birthday, each day might have multiple birthdays on it.</p>

<h3>Doctor&#8217;s Office</h3>

<p>Patients can have many appointments.</p>

<h3>Report Card</h3>

<p>Students have many subjects, and a grade in each subject</p>

<h3>Shopping List</h3>

<p>Products have a name and a unit price.
There are many stores.</p>

<p>A store can have many products (all priced the same across all stores).</p>

<h2>Layering on CLI</h2>

<p>So far, we have been interacting with our application via tests. However, it would
be nice if we could type commands in our terminal and get some output instead.</p>

<p>To do so, we are going to build a Command-line Interface (CLI) for our CSV program
by creating a Read-Evaluate-Print Loop (REPL) that will be waiting for our commands.</p>

<h3>Getting Started</h3>

<p>You can either work on your own CSV program implementation, or get the <code>level-ii-solution</code> branch in the <a href="https://github.com/JumpstartLab/csv-exercises/tree/level-ii-solution">csv-exercises repository</a>.
<strong>NOTE: Only phone_book has a solution in the repository</strong></p>

<p>If you are using the remote repository, fetch all the branches from the <code>csv-exercises</code> folder
by running <code>git fetch --all</code> from your terminal.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git fetch --all
</span><span class='line'>Fetching origin
</span></code></pre></td></tr></table></div></figure>

<p>If everything worked fine, you should be able to see all the branches listed in your repo.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git branch -r
</span><span class='line'>origin/HEAD -&gt; origin/master
</span><span class='line'>origin/level-i-solution
</span><span class='line'>origin/level-ii-solution
</span><span class='line'>origin/master
</span></code></pre></td></tr></table></div></figure>

<p>Now, just create a new branch that tracks a remote branch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git checkout --track origin/level-ii-solution
</span><span class='line'>Branch level-ii-solution <span class="nb">set </span>up to track remote branch level-ii-solution from origin.
</span><span class='line'>Switched to a new branch <span class="s1">&#39;level-ii-solution&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now change directories into <code>level-ii/phone_book</code> and your are ready to go.</p>

<h3>Goals</h3>

<p>The goal of our CLI is to support the following commands:</p>

<ul>
<li>look up by last name (e.g. &quot;Smith&quot;)</li>
<li>look up by last name, first name (e.g. &quot;Smith, Alice&quot;)</li>
<li>reverse lookup (e.g. &quot;(111) 555-1234&quot;)</li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lookup <span class="s2">&quot;Hudson&quot;</span>
</span><span class='line'><span class="nv">$ </span>lookup <span class="s2">&quot;Hudson, Clara&quot;</span>
</span><span class='line'><span class="nv">$ </span>lookup -r <span class="s2">&quot;(577) 491-0484&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<h3>The First Test</h3>

<p>We are going to create a <code>CLI</code> class that will handle the processing of commands.
Create a <code>cli_test.rb</code> file under the <code>test</code> folder and require <code>minitest</code> and
the files that you will be needing for this test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/cli&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/entry_repository&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/phone_book&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CLITest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, let&#8217;s create the setup for our first test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/cli&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/entry_repository&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/phone_book&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CLITest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:cli</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="n">repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s2">&quot;./test/fixtures&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@cli</span> <span class="o">||=</span> <span class="no">CLI</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Here, we are creating a new <code>repository</code> that is loading the test fixtures.
Then we are creating a <code>phone_book</code> with the data from that repository. Finally,
we are creating a new CLI object, and we are passing the <code>phone_book</code> object that holds all
the functionality that we are going to access through the CLI.</p>

<p>It&#8217;s time to write the first test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_exists</span>
</span><span class='line'>  <span class="n">assert</span> <span class="n">cli</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Create a <code>cli.rb</code> file under your <code>lib</code> folder and create a <code>CLI</code> class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CLI</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, run the tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby <span class="nb">test</span>/cli_test.rb
</span><span class='line'>Run options: --seed 60950
</span><span class='line'>
</span><span class='line'><span class="c"># Running:</span>
</span><span class='line'>
</span><span class='line'>.
</span><span class='line'>
</span><span class='line'>Fabulous run in 0.005351s, 186.8810 runs/s, 186.8810 assertions/s.
</span><span class='line'>
</span><span class='line'>1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre></td></tr></table></div></figure>

<p>Our test should be passing.</p>

<h3>Adding Attributes</h3>

<p>Our CLI interface needs to have a <code>command</code>, <code>parameters</code> and a <code>phone_book</code>.
The <code>command</code> will store our current instructions, the <code>parameters</code> will be the
arguments for that command, and the <code>phone_book</code> will be the object that holds
the functionality that we want to access.</p>

<p>Let&#8217;s write the next tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_has_a_command</span>
</span><span class='line'>  <span class="n">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">command</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_it_has_parameters</span>
</span><span class='line'>  <span class="n">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">parameters</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_it_has_a_phone_book</span>
</span><span class='line'>  <span class="n">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">phone_book</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>To make them pass, we need to initialize our CLI object with three attributes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:command</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:parameters</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:phone_book</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@command</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@parameters</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@phone_book</span> <span class="o">=</span> <span class="n">phone_book</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Handling Commands and Parameters</h3>

<p>Now that we have our attributes, we need to start thinking about the structure
of our command. Ideally, we would want to be able to type <code>lookup &quot;Hudson, Clara&quot;</code>,
right? If we see this, we can observe that the first word, <code>lookup</code> is the command,
and &quot;Hudson, Clara&quot; are the parameters.</p>

<p>Let&#8217;s write a test that will take a string -our command- and split it into an array.
This will allow us to identify each element either as a <code>command</code> or as a <code>parameter</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_process_input</span>
</span><span class='line'>  <span class="n">input</span>  <span class="o">=</span> <span class="s1">&#39;lookup &quot;Smith, Alice&quot;&#39;</span>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s1">&#39;lookup&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;Smith,&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&quot;&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Let&#8217;s make this pass.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This works fine, but our parameters are in the wrong format. We want to be able
to pass them as a single string. Let&#8217;s write a method that will format those into
the right data structure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_formats_parameters</span>
</span><span class='line'>  <span class="n">parameters</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;&quot;Smith,&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&quot;&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">result</span>     <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">format_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Smith, Alice&quot;</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Let&#8217;s implement this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">format_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>  <span class="n">parameters</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is better, but we haven&#8217;t mapped our command nor our parameters to the CLI
attributes. It would be nice if we can pass the processed input to some method
and get them assigned.</p>

<p>To do so, let&#8217;s write a test first.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_assigns_instructions</span>
</span><span class='line'>  <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup </span><span class="se">\&quot;</span><span class="s2">Smith, Alice</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;lookup&quot;</span><span class="p">,</span>       <span class="n">cli</span><span class="o">.</span><span class="n">command</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Smith, Alice&quot;</span><span class="p">,</span> <span class="n">cli</span><span class="o">.</span><span class="n">parameters</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Let&#8217;s now implement this functionality.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@command</span>    <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@parameters</span> <span class="o">=</span> <span class="n">format_parameters</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Our implementation has a problem, though. If we look at the requirements, we have
to be able to pass a flag in our command so that we can execute a reverse lookup. That
would look something like this <code>lookup -r &quot;(577) 491-0484&quot;</code>.</p>

<p>Let&#8217;s write another test to handle that functionality.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_assings_instructions_with_flag</span>
</span><span class='line'>  <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup -r </span><span class="se">\&quot;</span><span class="s2">Smith, Alice</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;lookup -r&quot;</span><span class="p">,</span>    <span class="n">cli</span><span class="o">.</span><span class="n">command</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Smith, Alice&quot;</span><span class="p">,</span> <span class="n">cli</span><span class="o">.</span><span class="n">parameters</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, let&#8217;s modify our implementation accordingly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;-r&quot;</span>
</span><span class='line'>    <span class="vi">@command</span>    <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@parameters</span> <span class="o">=</span> <span class="n">format_parameters</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@command</span>    <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@parameters</span> <span class="o">=</span> <span class="n">format_parameters</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Executing Commands</h3>

<p>Now that we can take an instruction, split it into commands and parameters and
assign them to our CLI, let&#8217;s process those commands.</p>

<p>Let&#8217;s write our test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_executes_the_lookup_command</span>
</span><span class='line'>  <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup </span><span class="se">\&quot;</span><span class="s2">Smith, Alice</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">execute_command</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_it_executes_the_reverse_lookup_command</span>
</span><span class='line'>  <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup -r </span><span class="se">\&quot;</span><span class="s2">(111) 000-1234</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>  <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">execute_command</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Let&#8217;s implement this functionality.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">execute_command</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">command</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;lookup&quot;</span>
</span><span class='line'>    <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;lookup -r&quot;</span>
</span><span class='line'>    <span class="n">phone_book</span><span class="o">.</span><span class="n">reverse_lookup</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you run your tests, all of them should be passing.</p>

<h3>Implementing the REPL</h3>

<p>Ok, so now we have all the pieces that we need, but you might be asking yourself
when are we going to be able to access the CLI.</p>

<p>Let&#8217;s start by creating the REPL by using a <code>while</code> loop. A while loop is a loop
that keeps running endlessly while some condition is still met.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">start</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Welcome to CSV.&quot;</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">command</span> <span class="o">!=</span> <span class="s2">&quot;quit&quot;</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;Enter your command: &quot;</span>
</span><span class='line'>    <span class="n">parts</span> <span class="o">=</span> <span class="n">process_input</span><span class="p">(</span><span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>    <span class="n">execute_command</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Good bye.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Ok, let&#8217;s see what this method is doing. First, we are printing something out to
the terminal. This message is not necessary, it is used only for human consumption.</p>

<p>Then, we are starting our while loop, and this loop will continue to run while
our <code>command</code> is different than <code>quit</code>. You could also use <code>until</code> instead of <code>while</code>
as long as you invert the condition.</p>

<p>Later, we are printing the line where we will be entering the command. This is also
for human consumption.</p>

<p>Maybe you noticed that we are using <code>print</code> instead of <code>puts</code>. While <code>puts</code> prints
a new line at the end, <code>print</code> does not.</p>

<p>Also, we are using <code>gets</code> to get the input that we are entering in our REPL, and
<code>chomp</code> to delete all trailing return and newline characters.</p>

<p>Finally, we are calling the methods that we defined before.</p>

<h3>Wiring Things Up</h3>

<p>All this work is pretty cool, but how can we start our program? We want to be able
to run <code>ruby phone_book.rb</code> and start the application.</p>

<p>To do so, let&#8217;s create a <code>phone_book.rb</code> file at the root of our project, the
<code>phone_book</code> directory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>touch phone_book.rb
</span></code></pre></td></tr></table></div></figure>

<p>On that file, we are going to load all the files inside our &#8216;lib&#8217; folder. Put
the following code in your file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;./lib/*.rb&quot;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Also, I want to be able to run the CLI program from here. Let&#8217;s include that in
the file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;./lib/*.rb&quot;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="no">CLI</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>

<p>However, we don&#8217;t have a <code>run</code> class method yet. So let&#8217;s create it in our CLI
class.</p>

<p>This method <code>run</code> will handle all the setup for our CLI object: it will create
a new repository, a new phone_book and will initialize an instance of the CLI class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span>
</span><span class='line'>  <span class="n">repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="kp">new</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, if you run your program, you will see that is expecting a command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby phone_book.rb
</span><span class='line'>Welcome to CSV.
</span><span class='line'>Enter your <span class="nb">command</span>:
</span></code></pre></td></tr></table></div></figure>

<p>However, if you type <code>lookup &quot;Smith&quot;</code> you are not going to be able to see anything.
Why do you think is that?</p>

<p>If we go back to our code, we see that the <code>execute_command</code> method is not printing
anything to the terminal. Let&#8217;s modify this method a little.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">execute_command</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">command</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;lookup&quot;</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">output</span>
</span><span class='line'>    <span class="n">output</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;lookup -r&quot;</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">reverse_lookup</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">output</span>
</span><span class='line'>    <span class="n">output</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, if you type <code>lookup &quot;Smith&quot;</code>, for example, it will return a list of matches.</p>

<p>This is the code that I have.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CLI</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span>
</span><span class='line'>    <span class="n">repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:command</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:parameters</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:phone_book</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@command</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@parameters</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@phone_book</span> <span class="o">=</span> <span class="n">phone_book</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">start</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Welcome to CSV.&quot;</span>
</span><span class='line'>    <span class="k">while</span> <span class="n">command</span> <span class="o">!=</span> <span class="s2">&quot;quit&quot;</span>
</span><span class='line'>      <span class="nb">print</span> <span class="s2">&quot;Enter your command: &quot;</span>
</span><span class='line'>      <span class="n">parts</span> <span class="o">=</span> <span class="n">process_input</span><span class="p">(</span><span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span><span class="p">)</span>
</span><span class='line'>      <span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>      <span class="n">execute_command</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Good bye.&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;-r&quot;</span>
</span><span class='line'>      <span class="vi">@command</span>    <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@parameters</span> <span class="o">=</span> <span class="n">format_parameters</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="vi">@command</span>    <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@parameters</span> <span class="o">=</span> <span class="n">format_parameters</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">format_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>    <span class="n">parameters</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">execute_command</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Executing </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">command</span>
</span><span class='line'>    <span class="k">when</span> <span class="s2">&quot;lookup&quot;</span>
</span><span class='line'>      <span class="n">output</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">output</span>
</span><span class='line'>      <span class="n">output</span>
</span><span class='line'>    <span class="k">when</span> <span class="s2">&quot;lookup -r&quot;</span>
</span><span class='line'>      <span class="n">output</span> <span class="o">=</span> <span class="n">phone_book</span><span class="o">.</span><span class="n">reverse_lookup</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">output</span>
</span><span class='line'>      <span class="n">output</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>And these are my tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/cli&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/entry_repository&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/phone_book&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CLITest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:cli</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="n">repository</span> <span class="o">=</span> <span class="no">EntryRepository</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="s2">&quot;./test/fixtures&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">phone_book</span> <span class="o">=</span> <span class="no">PhoneBook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@cli</span> <span class="o">||=</span> <span class="no">CLI</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">phone_book</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_exists</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">cli</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_has_a_command</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">command</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_has_parameters</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">parameters</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_has_a_phone_book</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">cli</span><span class="o">.</span><span class="n">phone_book</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_process_input</span>
</span><span class='line'>    <span class="n">input</span>  <span class="o">=</span> <span class="s1">&#39;lookup &quot;Smith, Alice&quot;&#39;</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s1">&#39;lookup&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;Smith,&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&quot;&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_formats_parameters</span>
</span><span class='line'>    <span class="n">parameters</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;&quot;Smith,&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&quot;&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">result</span>     <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">format_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Smith, Alice&quot;</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_assigns_instructions</span>
</span><span class='line'>    <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup </span><span class="se">\&quot;</span><span class="s2">Smith, Alice</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;lookup&quot;</span><span class="p">,</span>       <span class="n">cli</span><span class="o">.</span><span class="n">command</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Smith, Alice&quot;</span><span class="p">,</span> <span class="n">cli</span><span class="o">.</span><span class="n">parameters</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_assings_instructions_with_flag</span>
</span><span class='line'>    <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup -r </span><span class="se">\&quot;</span><span class="s2">Smith, Alice</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;lookup -r&quot;</span><span class="p">,</span>    <span class="n">cli</span><span class="o">.</span><span class="n">command</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Smith, Alice&quot;</span><span class="p">,</span> <span class="n">cli</span><span class="o">.</span><span class="n">parameters</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_executes_the_lookup_command</span>
</span><span class='line'>    <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup </span><span class="se">\&quot;</span><span class="s2">Smith, Alice</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">execute_command</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_executes_the_reverse_lookup_command</span>
</span><span class='line'>    <span class="n">input</span>  <span class="o">=</span> <span class="s2">&quot;lookup -r </span><span class="se">\&quot;</span><span class="s2">(111) 000-1234</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">parts</span>  <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cli</span><span class="o">.</span><span class="n">assign_instructions</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">execute_command</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>            <span class="n">result</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;(111) 000-1234&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">numbers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Next Steps</h3>

<p>Now that you have your CLI implemented, can you do the following?</p>

<ul>
<li>Handle single quote commands: try <code>lookup 'Smith'</code> why doesn&#8217;t it work? Try to
fix this.</li>
<li>Handle missing instructions: what happens if you give the CLI an instruction
that doesn&#8217;t exist? Wouldn&#8217;t it be nice if you could show the user a message?</li>
<li>Handle other types of data: try wiring other pieces of behaviour such as the
Calendar or the Report Card.</li>
<li>Implement help: Try implementing a <code>help</code> command that will list all available
commands to the user in the terminal.</li>
</ul>

    
    
      <footer>
        
        
          <div class="sharing">
  
  
</div>

        
      </footer>
    
  </article>


</div>


  <span class="toggle-sidebar"></span>

<aside class="sidebar">
  <div> </div>
</aside>

<script src="/javascripts/sidebar.js" type="text/javascript"> </script>


    </div>

    <div class="footer">
  <p>
    All materials licensed <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0</a>&nbsp;
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" />
  </p>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42709122-1', 'jumpstartlab.com');
ga('send', 'pageview');
</script>
  </div>

  


  <div class="slide-out-div">
  <a class="handle" href="#">Feedback</a>
  <h3>Have Feedback?</h3>
  <p>Did you find an error? Something confusing? We'd love your help:</p>
  <ul>
    <li><a href="#" id="edit_source">Edit the source code of this page directly on GitHub</a></li>
    <li><a href="https://github.com/JumpstartLab/curriculum/issues">Create a new issue on the project's GitHub page</a></li>
  </ul>
  <p>Thanks!</p>
</div>

<script>
  $(function(){
    var pathname = window.location.pathname.replace( ".html", ".markdown" );
    var github_url = "https://github.com/JumpstartLab/curriculum/blob/master/source" + pathname;
    $("a#edit_source").attr('href', github_url);
  });
</script>

</body>
</html>
